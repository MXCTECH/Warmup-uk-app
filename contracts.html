<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Warm Up UK Homes — Contract Builder</title>
<link rel="icon" href="assets/warmupuk-logo.png.PNG" />
<style>
  :root{
    --bg:#0b0b0b; --panel:#131313; --edge:#d4af37; --muted:#888; --text:#eee; --accent:#ffd54d;
    --ok:#19e56a; --ok-glow:0 0 14px rgba(25,229,106,.7);
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:980px;margin:20px auto;padding:0 16px}
  .card{background:linear-gradient(180deg,#1a150b 0%,#0e0b06 100%);border:1px solid #6e5517;border-radius:20px;padding:18px 18px 14px;position:sticky;top:0;z-index:5}
  header{display:flex;gap:16px;align-items:center}
  #logo{width:64px;height:64px;object-fit:contain;border-radius:12px;border:1px solid #65501a;background:#111}
  .ttl{flex:1}
  h1{font-size:28px;margin:0 0 6px;letter-spacing:.02em}
  .sub{color:#cbb06a;opacity:.9}
  .actions{display:flex;gap:10px}
  .btn{border:1px solid var(--edge);color:#111;background:var(--accent);padding:10px 14px;border-radius:12px;font-weight:700}
  .btn.secondary{background:transparent;color:var(--accent)}
  .section{background:var(--panel);border:1px dashed #5c4814;border-radius:16px;padding:16px;margin:18px 0}
  .section>h2{margin:0 0 10px;color:var(--edge);letter-spacing:.06em}
  label{display:block;margin:8px 0 6px}
  input,select,textarea{width:100%;background:#0c0c0c;border:1px solid var(--edge);border-radius:12px;color:var(--text);padding:12px 12px}
  textarea{min-height:80px}
  /* products grid */
  .grid{display:grid;gap:10px;grid-template-columns:2fr .7fr .9fr .9fr auto}
  .grid .wide{grid-column:1/-1}
  .chip{display:inline-flex;align-items:center;gap:8px;border:1px dashed #6a5516;padding:8px 12px;border-radius:999px}
  .switch{appearance:none;position:relative;width:50px;height:28px;background:#333;border:1px solid #444;border-radius:999px;outline:none;cursor:pointer;vertical-align:middle}
  .switch:before{content:"";position:absolute;left:2px;top:2px;width:22px;height:22px;background:#bbb;border-radius:50%;transition:.2s}
  .switch:checked{background:#0d401f;border-color:#19e56a;box-shadow:var(--ok-glow)}
  .switch:checked:before{left:26px;background:#19e56a}
  .flash{animation:flash 1.2s ease-in-out infinite alternate}
  @keyframes flash{from{background:#102f18}to{background:#19e56a}}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .pill{padding:10px 14px;border-radius:999px;border:1px solid #6e5517}
  .pill.ok{background:#132c1c;border-color:#19e56a}
  .totals{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  .kpi{border:2px solid var(--edge);border-radius:14px;padding:12px 14px;font-weight:800;font-size:22px;display:flex;justify-content:space-between;align-items:center}
  .kpi span{font-size:16px;color:#cbb06a;font-weight:600}
  .muted{color:var(--muted)}
  .sig{background:#fff;border-radius:12px;border:2px dashed var(--edge);height:180px}
  footer{opacity:.8;text-align:center;margin:18px 0}
  .store{display:flex;justify-content:space-between;align-items:center;border-top:1px dashed #5c4814;padding-top:10px;margin-top:6px}
  .small{font-size:.9rem}
  @media (max-width:720px){
    .grid{grid-template-columns:1fr 1fr}
    .grid > *:nth-child(3), .grid > *:nth-child(4), .grid > *:nth-child(5){grid-column:span 1}
    .totals{grid-template-columns:1fr}
  }
  /* print */
  @media print{
    .card,.actions,.store{position:static!important}
    .btn,.actions{display:none!important}
    body{background:#fff;color:#000}
    .section{border-color:#aaa}
    .sig{border-color:#000}
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Sticky header -->
    <div class="card">
      <header>
        <img id="logo" src="assets/warmupuk-logo.png.PNG" alt="Warm Up UK Homes logo"
             onerror="this.src='https://dummyimage.com/64x64/111/ffd54d&text=UK'">
        <div class="ttl">
          <h1>WARM UP UK HOMES</h1>
          <div class="sub">Contract Builder · Black &amp; Gold Theme</div>
        </div>
        <div class="actions">
          <button class="btn" id="printBtn">Print / Save PDF</button>
          <button class="btn secondary" id="waBtn">Share via WhatsApp</button>
        </div>
      </header>
    </div>

    <!-- Contract meta -->
    <div class="section">
      <div class="row">
        <div style="flex:1">
          <label>Contract Number</label>
          <input id="contractNo" readonly />
        </div>
        <div style="flex:1">
          <label>Date</label>
          <input id="contractDate" type="date" />
        </div>
      </div>
      <div class="row">
        <div style="flex:1">
          <label>Client name</label>
          <input id="client" placeholder="Full name" />
        </div>
        <div style="flex:1">
          <label>Contact number (WhatsApp)</label>
          <input id="phone" placeholder="+44… or 07…" />
        </div>
      </div>
      <label>Property address</label>
      <input id="address" placeholder="Address, Postcode" />
      <div class="row">
        <div style="flex:1">
          <label>Rep</label>
          <input id="rep" placeholder="Rep name" />
        </div>
        <div style="flex:1">
          <label>Job type</label>
          <select id="job">
            <option>Loft Insulation</option>
            <option>Underfloor Insulation</option>
            <option>Room in Roof</option>
            <option>Other</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Products & Pricing -->
    <div class="section">
      <h2>PRODUCTS &amp; PRICING</h2>

      <div id="lines">
        <div class="grid line">
          <div>
            <label>Description</label>
            <textarea class="desc" placeholder="e.g., Loft insulation — supply & fit, 270mm…"></textarea>
          </div>
          <div>
            <label>Qty</label>
            <input type="number" class="qty" value="1" min="0" />
          </div>
          <div>
            <label>Unit £</label>
            <input type="number" class="unit" value="0" min="0" step="0.01" />
          </div>
          <div>
            <label>Line £</label>
            <input class="lineTotal" value="0.00" readonly />
          </div>
          <div class="row" style="align-self:end;">
            <button type="button" class="btn secondary" onclick="removeLine(this)">×</button>
          </div>
          <div class="wide"><small class="muted">Tip: bigger description box for scope details and notes.</small></div>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="btn secondary" type="button" onclick="addLine()">+ Add line</button>
      </div>

      <div class="row" style="margin-top:14px">
        <span class="chip">
          <strong>Apply VAT (20%)</strong>
          <input id="vatSwitch" class="switch" type="checkbox" checked />
        </span>

        <span class="chip">
          <strong>Enable Discount</strong>
          <input id="discSwitch" class="switch" type="checkbox" />
        </span>

        <span class="pill">Subtotal: <b id="subView" style="margin-left:6px">£0.00</b></span>
        <span class="pill">VAT: <b id="vatView" style="margin-left:6px">£0.00</b></span>
      </div>

      <!-- Discount block (separate) -->
      <div id="discountBlock" class="section" style="margin:14px 0 0; display:none">
        <div class="row">
          <div style="flex:1">
            <label>Discount <b>Before</b> (£)</label>
            <input id="discBefore" type="number" min="0" step="0.01" value="0" class="flash" />
          </div>
          <div style="flex:1">
            <label>Discount <b>After</b> (£)</label>
            <input id="discAfter" type="number" min="0" step="0.01" value="0" class="flash" />
          </div>
        </div>
        <small class="muted">Both boxes illuminate bright green when enabled. Toggle “Enable Discount” to hide/show.</small>
      </div>

      <!-- Totals -->
      <div class="totals" style="margin-top:14px">
        <div class="kpi"><span>Grand Total</span> <b id="grand">£0.00</b></div>
        <div class="kpi"><span>VAT (20%)</span> <b id="grandVat">£0.00</b></div>
        <div class="kpi"><span>Deposit (paid / due now)</span>
          <input id="deposit" type="number" min="0" step="0.01" value="0" style="max-width:160px" />
        </div>
        <div class="kpi ok"><span>Final to Pay Today</span> <b id="finalToday">£0.00</b></div>
        <div class="kpi"><span>Balance Due on Completion</span> <b id="balance">£0.00</b></div>
      </div>
    </div>

    <!-- Notes + Signature -->
    <div class="section">
      <label>Notes / Special Instructions</label>
      <textarea id="notes" placeholder="Enter job notes or installation details"></textarea>

      <h2 style="margin-top:14px">Client Signature</h2>
      <div class="sig" id="sigPad"></div>
      <div class="row small">
        <span class="muted">Sign inside the box. Clear:</span>
        <button class="btn secondary" type="button" onclick="clearSig()">Clear</button>
      </div>
    </div>

    <!-- Store mode -->
    <div class="section">
      <div class="store">
        <div>
          <strong>Store mode</strong><br>
          <span class="muted small">Save/Load contract data locally on this device (no cloud).</span>
        </div>
        <div class="row">
          <button class="btn secondary" type="button" onclick="saveDraft()">Save draft</button>
          <button class="btn secondary" type="button" onclick="loadDraft()">Load draft</button>
          <button class="btn secondary" type="button" onclick="clearDraft()">Clear draft</button>
        </div>
      </div>
    </div>

    <footer class="muted small">© Warm Up UK Homes</footer>
  </div>

<script>
/* ===== Helpers ===== */
const £ = sel => document.querySelector(sel);
const ££ = sel => [...document.querySelectorAll(sel)];
const money = v => '£' + (isNaN(v)?0:Number(v)).toFixed(2);

/* ===== Contract number + date ===== */
function genContractNo(){
  const d = new Date();
  const pad = n => String(n).padStart(2,'0');
  const day = pad(d.getDate());
  const month = pad(d.getMonth()+1);
  const year = String(d.getFullYear()).slice(2);
  const rnd = Math.floor(1000 + Math.random()*9000);
  return `WUUK-${day}${month}${year}-${rnd}`;
}

function initMeta(){
  const cNo = localStorage.getItem('wuuk:lastContractNo') || genContractNo();
  $('#contractNo').value = cNo;
  localStorage.setItem('wuuk:lastContractNo', cNo);
  $('#contractDate').value = new Date().toISOString().slice(0,10);
}

/* ===== Lines ===== */
function lineTotal(row){
  const qty = Number(row.querySelector('.qty').value||0);
  const unit= Number(row.querySelector('.unit').value||0);
  const total = qty*unit;
  row.querySelector('.lineTotal').value = total.toFixed(2);
}

function addLine(){
  const tpl = document.querySelector('.grid.line').cloneNode(true);
  tpl.querySelectorAll('input,textarea').forEach(el=>{
    if(el.classList.contains('qty')) el.value = 1;
    else if(el.classList.contains('unit')) el.value = 0;
    else if(el.classList.contains('lineTotal')) el.value = '0.00';
    else el.value = '';
  });
  $('#lines').appendChild(tpl);
  bindRow(tpl);
  recalc();
}

function removeLine(btn){
  const rows = ££('.grid.line');
  if(rows.length===1){
    // clear instead of remove last
    rows[0].querySelector('.desc').value='';
    rows[0].querySelector('.qty').value=1;
    rows[0].querySelector('.unit').value=0;
    rows[0].querySelector('.lineTotal').value='0.00';
  }else{
    btn.closest('.grid.line').remove();
  }
  recalc();
}

function bindRow(row){
  ['input','change'].forEach(ev=>{
    row.addEventListener(ev, e=>{
      if(e.target.matches('.qty,.unit')) lineTotal(row);
      recalc();
    });
  });
}
££('.grid.line').forEach(bindRow);

/* ===== Discount & VAT toggles ===== */
$('#discSwitch').addEventListener('change', e=>{
  $('#discountBlock').style.display = e.target.checked ? 'block':'none';
  recalc();
});
$('#vatSwitch').addEventListener('change', recalc);
$('#discBefore').addEventListener('input', recalc);
$('#discAfter').addEventListener('input', recalc);
$('#deposit').addEventListener('input', recalc);

/* ===== Totals calc ===== */
function sumLines(){
  return ££('.grid.line').reduce((s,row)=> s + Number(row.querySelector('.lineTotal').value||0), 0);
}
function recalc(){
  const subtotal = sumLines();
  $('#subView').textContent = money(subtotal);

  const vatOn = $('#vatSwitch').checked;
  const vatVal = vatOn ? subtotal*0.20 : 0;
  $('#vatView').textContent = money(vatVal);

  const discOn = $('#discSwitch').checked;
  const discBefore = discOn ? Number($('#discBefore').value||0) : 0;
  const discAfter  = discOn ? Number($('#discAfter').value||0)  : 0;

  const grandBefore = Math.max(subtotal - discBefore, 0);
  const grandVat = vatOn ? grandBefore*0.20 : 0;
  const grand = grandBefore + grandVat - discAfter;

  $('#grand').textContent = money(grandBefore);
  $('#grandVat').textContent = money(grandVat);

  const deposit = Number($('#deposit').value||0);
  const finalToday = Math.max(grand - deposit, 0);
  const balance = Math.max(grand - finalToday, 0);

  $('#finalToday').textContent = money(finalToday);
  $('#balance').textContent = money(balance);
}

/* ===== Signature (simple canvas) ===== */
let pad, drawing=false, ctx;
function initSig(){
  pad = $('#sigPad');
  const c = document.createElement('canvas');
  c.width = pad.clientWidth - 8; c.height = pad.clientHeight - 8;
  pad.innerHTML=''; pad.appendChild(c);
  ctx = c.getContext('2d'); ctx.lineWidth=2; ctx.strokeStyle='#000';
  const xy = e => {
    const r = c.getBoundingClientRect();
    const t = (e.touches? e.touches[0]: e);
    return {x:t.clientX - r.left, y:t.clientY - r.top};
  };
  c.addEventListener('mousedown', e=>{drawing=true; ctx.beginPath(); const p=xy(e); ctx.moveTo(p.x,p.y);});
  c.addEventListener('mousemove', e=>{ if(!drawing) return; const p=xy(e); ctx.lineTo(p.x,p.y); ctx.stroke();});
  c.addEventListener('mouseup', ()=> drawing=false);
  c.addEventListener('mouseleave', ()=> drawing=false);
  c.addEventListener('touchstart', e=>{e.preventDefault(); drawing=true; ctx.beginPath(); const p=xy(e); ctx.moveTo(p.x,p.y);});
  c.addEventListener('touchmove', e=>{e.preventDefault(); if(!drawing) return; const p=xy(e); ctx.lineTo(p.x,p.y); ctx.stroke();});
  c.addEventListener('touchend', ()=> drawing=false);
}
function clearSig(){ initSig(); }

/* ===== WhatsApp + Print ===== */
$('#printBtn').addEventListener('click', ()=> window.print());

$('#waBtn').addEventListener('click', async ()=>{
  const msg = `WARM UP UK HOMES%0AContract: ${encodeURIComponent($('#contractNo').value)}
Client: ${encodeURIComponent($('#client').value)}
Address: ${encodeURIComponent($('#address').value)}
Total: ${encodeURIComponent($('#finalToday').textContent)}%0A%0A— Sent from Contract Builder`;
  // Try native share
  if(navigator.share){
    try{
      await navigator.share({title:'Warm Up UK Homes', text: decodeURIComponent(msg)});
      return;
    }catch(e){}
  }
  // Fallback to WhatsApp
  const url = `https://wa.me/?text=${msg}`;
  window.open(url,'_blank');
});

/* ===== Store mode ===== */
const STORE_KEY = 'wuuk:contract';
function snapshot(){
  return {
    contractNo: $('#contractNo').value,
    date: $('#contractDate').value,
    client: $('#client').value,
    phone: $('#phone').value,
    address: $('#address').value,
    rep: $('#rep').value,
    job: $('#job').value,
    deposit: $('#deposit').value,
    lines: ££('.grid.line').map(r=>({
      desc: r.querySelector('.desc').value,
      qty: r.querySelector('.qty').value,
      unit: r.querySelector('.unit').value
    })),
    vat: $('#vatSwitch').checked,
    discOn: $('#discSwitch').checked,
    discBefore: $('#discBefore').value,
    discAfter: $('#discAfter').value,
    notes: $('#notes').value
  };
}
function applySnap(s){
  if(!s) return;
  $('#contractNo').value = s.contractNo || genContractNo();
  $('#contractDate').value = s.date || new Date().toISOString().slice(0,10);
  $('#client').value = s.client||''; $('#phone').value=s.phone||''; $('#address').value=s.address||'';
  $('#rep').value=s.rep||''; $('#job').value=s.job||'';
  $('#deposit').value=s.deposit||0;
  $('#lines').innerHTML='';
  (s.lines&&s.lines.length?s.lines:[{desc:'',qty:1,unit:0}]).forEach(l=>{
    addLine();
    const r = ££('.grid.line').slice(-1)[0];
    r.querySelector('.desc').value = l.desc||'';
    r.querySelector('.qty').value  = l.qty ?? 1;
    r.querySelector('.unit').value = l.unit ?? 0;
    lineTotal(r);
  });
  $('#vatSwitch').checked= !!s.vat;
  $('#discSwitch').checked = !!s.discOn;
  $('#discountBlock').style.display = $('#discSwitch').checked?'block':'none';
  $('#discBefore').value = s.discBefore||0;
  $('#discAfter').value  = s.discAfter||0;
  $('#notes').value = s.notes||'';
  recalc();
}
function saveDraft(){ localStorage.setItem(STORE_KEY, JSON.stringify(snapshot())); alert('Saved draft.'); }
function loadDraft(){
  const raw = localStorage.getItem(STORE_KEY);
  if(!raw) return alert('No saved draft found.');
  applySnap(JSON.parse(raw)); alert('Loaded saved contract.');
}
function clearDraft(){ localStorage.removeItem(STORE_KEY); alert('Draft cleared.'); }

/* ===== Init ===== */
function $(q){return document.querySelector(q)}
initMeta();
initSig();
recalc();
document.addEventListener('input', e=>{
  if(['INPUT','SELECT','TEXTAREA'].includes(e.target.tagName)) recalc();
});
addEventListener('resize', ()=> setTimeout(initSig, 50)); // keep canvas fitting on rotate
</script>
</body>
</html>
