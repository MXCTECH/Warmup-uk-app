<!-- Warm Up UK Logo Footer -->
<div style="text-align:center;margin-top:40px;">
  <img src="11A155C8-468D-489E-816B-13E581F6F652.png" 
       alt="Warm Up UK Logo" 
       style="width:120px;height:auto;">
</div>


<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Warm Up UK ‚Äî Install Calendar</title>
<link rel="preconnect" href="https://unpkg.com" crossorigin>
<style>
:root{
  --bg:#0b0d12; --panel:#12151c; --panel2:#0f1218;
  --gold:#d4af37; --ink:#e7e8ea; --muted:#9aa3ad; --line:#212632; --danger:#c62828;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
a{color:var(--gold);text-decoration:none}
.hidden{display:none!important}
.goldbar{height:6px;background:var(--gold)}
.wrap{max-width:1100px;margin:0 auto;padding:0 14px}
header{position:sticky;top:0;z-index:20;background:var(--panel);border-bottom:1px solid var(--line)}
.head{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 0}
.brand{display:flex;align-items:center;gap:10px}
.brand img{height:30px;width:auto;border-radius:3px}
.brand h1{font-size:18px;margin:0}
.brand small{display:block;color:var(--muted)}
.actions{display:flex;gap:10px;flex-wrap:wrap}
.btn{appearance:none;border:1px solid var(--line);background:#10141b;color:#e7e8ea;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.btn-primary{background:var(--gold);color:#000;border-color:transparent}
.btn-ok{background:#2a2f3a;color:var(--gold);border:1px solid rgba(212,175,55,.35)}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;margin:18px 0 32px}
.card{grid-column:span 12;background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:14px;overflow:hidden}
.card h2{margin:0;padding:12px 14px;color:var(--gold);font-size:16px;border-bottom:1px solid var(--line);background:rgba(212,175,55,.06)}
.card .body{padding:14px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:860px){.row{grid-template-columns:1fr}}
.input,select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#0c1016;color:#e7e8ea}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-top:1px solid var(--line);padding:8px;text-align:left}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:#bfc6cf;background:#0b0f15}
.pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;background:rgba(212,175,55,.14);border:1px solid rgba(212,175,55,.35);color:var(--gold)}
.footer-strip{border-top:1px solid var(--line);background:#0f1218;color:#cdd2da;font-size:12px}
.footer-strip .wrap{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 0;flex-wrap:wrap}
.footer-strip .contact{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
.footer-strip .contact span::before{content:'‚Ä¢';margin:0 8px;color:#4a4f58}
.footer-strip .contact span:first-child::before{content:'';margin:0}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;place-items:center;z-index:9999}
.modal.show{display:grid}
.modal .sheet{width:min(620px,92vw);background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:14px;overflow:hidden}
.modal h3{margin:0;color:var(--gold);font-size:16px;padding:12px 14px;border-bottom:1px solid var(--line);background:rgba(212,175,55,.06)}
.modal .content{padding:14px}
.item{padding:12px;border-top:1px solid var(--line)}
</style>
</head>
<body>
<div class="goldbar"></div>
<header>
  <div class="wrap head">
    <div class="brand">
      <img src="WUUK.JPG" alt="Warm Up UK">
      <div><h1>Install Calendar</h1><small id="today"></small></div>
    </div>
    <div class="actions">
      <a class="btn" href="dashboard.html">‚Üê Back to Dashboard</a>
      <button class="btn" id="btnShareSettings">Share Settings</button>
    </div>
  </div>
  <div class="footer-strip">
    <div class="wrap">
      <div class="contact">
        <span>üìû 01708 300 670</span>
        <span>‚úâÔ∏è admin@warmupuk.com</span>
        <span>üåê www.warmupuk.com</span>
        <span>üè¢ 321‚Äì323 High Street, Romford, Essex RM6 6AX</span>
      </div>
      <span id="repViewBadge" class="badge hidden"></span>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <h2>Schedule</h2>
    <div class="body">
      <div class="row">
        <div><label>Filter by date</label><input type="date" id="installFilter" class="input"></div>
        <div style="align-self:end;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="clearInstallFilter">Clear</button>
          <button class="btn" id="openShareFromCalendar">Share‚Ä¶</button>
        </div>
      </div>
      <table class="table" id="installTable">
        <thead><tr><th>Date</th><th>Client</th><th>Postcode</th><th>Product</th><th>Rep</th><th>Contract</th></tr></thead>
        <tbody></tbody>
      </table>
      <p class="muted" style="margin-top:8px">Contracts shown here are those saved in this browser (local device).</p>
    </div>
  </section>
</main>

<!-- Share Settings Modal -->
<div class="modal" id="shareModal">
  <div class="sheet">
    <h3>Share Settings</h3>
    <div class="content">
      <div class="row">
        <div><label>Recipient Name</label><input id="s_name" class="input" placeholder="e.g. Ray Daniels"></div>
        <div>
          <label>Permissions</label>
          <select id="s_perm" class="input">
            <option value="view">View Only</option>
            <option value="edit">Can Edit</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div><label>Passcode (optional)</label><input id="s_pass" class="input" placeholder="Set a passcode for the link"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px">
        <button class="btn-primary" id="s_create">+ Create Share Link</button>
        <span class="muted">Links filter this calendar to that rep and include a token. Add a passcode for extra privacy.</span>
      </div>
      <hr style="border-color:#212632;border-width:0 0 1px;margin:12px 0">
      <div id="shareList"></div>
    </div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
const pad = n => n.toString().padStart(2,'0');
function slugify(s){ return (s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
function load(k,f){ try{ return JSON.parse(localStorage.getItem(k)) ?? f }catch{ return f } }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function token(){ return Math.random().toString(36).slice(2)+Math.random().toString(36).slice(2); }
async function hashPass(pass, tokenStr){
  const enc = new TextEncoder();
  const data = enc.encode((pass||'') + '|' + (tokenStr||''));
  const buf = await crypto.subtle.digest('SHA-256', data);
  const arr = Array.from(new Uint8Array(buf));
  return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
}

// Storage keys (same as dashboard)
const KEY_CONTRACTS='wuuk_contracts', KEY_SHARES='wuuk_shares';
let contracts=load(KEY_CONTRACTS,[]), shares=load(KEY_SHARES,[]);

// Header date
$('today').textContent = 'Today: ' + new Date().toLocaleDateString('en-GB',{day:'2-digit',month:'long',year:'numeric'});

// Rep/shared view state
let repFilter=null, viewPerm='edit';
function applyCalendarPermissions(){
  const shareBtn = $('openShareFromCalendar');
  const topShareBtn = $('btnShareSettings');
  const installingDisabled = (viewPerm==='view');
  if(shareBtn){ shareBtn.disabled = installingDisabled; shareBtn.textContent = installingDisabled? 'Share (disabled in shared view)' : 'Share‚Ä¶'; }
  if(topShareBtn){ topShareBtn.disabled = installingDisabled; }
}

// Render installs
function renderInstall(){
  const tbody=document.querySelector('#installTable tbody'); tbody.innerHTML='';
  const f=$('installFilter').value;
  const rows=contracts
    .filter(c=>c.install && (!f || c.install===f))
    .filter(c=>!repFilter || (c.rep && slugify(c.rep)===repFilter))
    .sort((a,b)=>a.install.localeCompare(b.install))
    .map(c=>`<tr><td>${c.install}</td><td>${c.client||''}</td><td>${c.postcode||''}</td><td>${c.product||''}</td><td>${c.rep||''}</td><td>${c.ref||''}</td></tr>`).join('');
  tbody.innerHTML = rows || `<tr><td colspan="6" class="muted">No installs${f?' on '+f:''}${repFilter?' for this rep':''}.</td></tr>`;
}
$('installFilter').addEventListener('change', renderInstall);
$('clearInstallFilter').addEventListener('click', ()=>{ $('installFilter').value=''; renderInstall(); });

// Share modal
function openShareModal(){ $('shareModal').classList.add('show'); renderShares(); }
function closeShareModal(){ $('shareModal').classList.remove('show'); }
$('btnShareSettings').addEventListener('click', openShareModal);
$('openShareFromCalendar').addEventListener('click', openShareModal);
$('shareModal').addEventListener('click', (e)=>{ if(e.target.id==='shareModal') closeShareModal(); });

function shareURL(rec){
  const base=location.origin+location.pathname;
  const h = rec.hash ? `&h=${encodeURIComponent(rec.hash)}` : '';
  const q=`?rep=${encodeURIComponent(rec.repSlug)}&token=${encodeURIComponent(rec.token)}&perm=${rec.perm}${h}`;
  return base+q;
}
function renderShares(){
  const box=$('shareList'); if(!box) return; box.innerHTML='';
  if(shares.length===0){ box.innerHTML='<p class="muted">No active share links yet.</p>'; return; }
  shares.forEach((r,i)=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`
      <div><strong>${r.name}</strong> <span class="muted">¬∑ ${r.perm==='edit'?'Can Edit':'View Only'} ¬∑ Created ${new Date(r.created).toLocaleDateString()}</span></div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px">
        <input class="input" style="min-width:260px" value="${shareURL(r)}" readonly>
        <button class="btn" data-copy="${i}">Copy</button>
        <button class="btn" data-edit="${i}">Rename</button>
        <button class="btn" data-del="${i}">Delete</button>
        <a class="btn" href="${shareURL(r)}" target="_blank">Open</a>
      </div>`;
    box.appendChild(el);
  });
}
$('s_create').addEventListener('click', async ()=>{
  const name=$('s_name').value.trim(); if(!name){ alert('Recipient name required'); return; }
  const perm=$('s_perm').value; const repSlug=slugify(name); const pass=$('s_pass').value.trim();
  const rec={ id:'share_'+Date.now(), name, role:'rep', perm, repSlug, token:token(), created:new Date().toISOString() };
  if(pass){ rec.hash = await hashPass(pass, rec.token); }
  shares.unshift(rec); save(KEY_SHARES,shares); renderShares();
  const link=shareURL(rec); navigator.clipboard.writeText(link).then(()=>alert('Share link copied: '+link),()=>prompt('Copy this link:',link));
  $('s_name').value=''; $('s_pass').value='';
});
$('shareList').addEventListener('click',(e)=>{
  const i = e.target.dataset.copy ?? e.target.dataset.del ?? e.target.dataset.edit;
  if(i===undefined) return; const idx=parseInt(i,10); const rec=shares[idx]; if(!rec) return;
  if(e.target.dataset.copy!==undefined){ const link=shareURL(rec); navigator.clipboard.writeText(link).then(()=>alert('Copied'),()=>prompt('Copy link:',link)); }
  if(e.target.dataset.del!==undefined){ if(confirm('Delete this share link?')){ shares.splice(idx,1); save(KEY_SHARES,shares); renderShares(); } }
  if(e.target.dataset.edit!==undefined){ const nm=prompt('New name', rec.name); if(nm){ rec.name=nm; rec.repSlug=slugify(nm); save(KEY_SHARES,shares); renderShares(); } }
});

// Routing from URL
(function initFromURL(){
  const p=new URLSearchParams(location.search);
  repFilter=p.get('rep')||null;
  const perm=p.get('perm')||'view';
  const tokenStr=p.get('token')||'';
  const h=p.get('h')||'';
  if(repFilter){ $('repViewBadge').textContent='Shared view ‚Ä¢ '+repFilter; $('repViewBadge').classList.remove('hidden'); }
  viewPerm=perm;
  async function proceed(){ renderInstall(); applyCalendarPermissions(); }
  if(h){
    (async ()=>{
      const pass = prompt('Enter passcode to view this calendar:');
      const computed = await hashPass(pass||'', tokenStr||'');
      if(computed===h){ await proceed(); }
      else{
        alert('Incorrect passcode. Access denied.');
        document.querySelector('#installTable tbody').innerHTML = '<tr><td colspan="6" class="muted">Access denied.</td></tr>';
        applyCalendarPermissions();
      }
    })();
  } else {
    proceed();
  }
})();

// Basic init
$('today').textContent = 'Today: ' + new Date().toLocaleDateString('en-GB',{day:'2-digit',month:'long',year:'numeric'});
$('installFilter').addEventListener('change', renderInstall);
$('clearInstallFilter').addEventListener('click', ()=>{ $('installFilter').value=''; renderInstall(); });
</script>
</body>
</html>
