<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WARM UP UK HOMES — Contract</title>

<!-- Fonts (optional, system fallbacks in CSS) -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<!-- PDF helpers -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#0b0d12; --panel:#121212; --ink:#e7e8ea;
  --gold:#d4af37; --gold-soft:#ffd766; --line:#222;
  --radius:16px; --shadow:0 10px 28px rgba(0,0,0,.55);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--ink);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}
a{color:var(--gold); text-decoration:none}
.wrap{max-width:980px; margin:22px auto; padding:0 14px}
.panel{
  background:#0f1015; border:1px solid #1e1f25; border-radius:var(--radius);
  box-shadow:var(--shadow); padding:22px;
}

/* Header (with slide/fade) */
header{
  position:sticky; top:0; z-index:10; margin-bottom:18px; border-radius:22px;
  background:linear-gradient(180deg,#3a2e11,#1f1a0a 35%, #15120a 65%, #110f0a);
  border:1px solid #3b3112; box-shadow:0 14px 40px rgba(0,0,0,.55);
  animation:slideFadeDown 1.2s ease forwards; opacity:0;
}
@keyframes slideFadeDown { from{transform:translateY(-18px);opacity:0} to{transform:translateY(0);opacity:1} }
.head{display:flex; align-items:center; gap:14px; padding:18px}
.brand{display:flex; align-items:center; gap:14px; min-height:56px}
.brand img{height:56px; width:auto; object-fit:contain; display:block}
.brand h1{margin:0; font-size:26px; letter-spacing:.08em}
.brand small{display:block; color:#b9a66a; margin-top:4px}
.actions{display:flex; gap:10px; margin-left:auto; flex-wrap:wrap}
.btn{
  appearance:none; border:1px solid #3b3112; background:#2d230b;
  color:#fff; padding:12px 16px; border-radius:12px; cursor:pointer;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.04), 0 3px 10px rgba(0,0,0,.3);
}
.btn:hover{filter:brightness(1.1)}
.btn.gold{background:linear-gradient(#e7c45a,#caa73f); color:#18150c; font-weight:700}

/* Section headings */
h2.title{
  margin:0 0 14px; padding:0 4px; font-size:20px; letter-spacing:.15em;
  color:var(--gold)
}

/* Form */
label{font-size:12px; color:#b6b7bb; display:block; margin-bottom:6px}
.input, textarea, select{
  width:100%; padding:14px 16px; border-radius:12px; border:1px solid #2a2b31;
  background:#0e1015; color:#e7e8ea; outline:none;
}
textarea{min-height:68px; resize:vertical}

/* Products table */
.grid-head, .line-row{
  display:grid; grid-template-columns: 1.2fr 90px 130px 130px 44px; gap:10px;
  align-items:center;
}
.grid-head{color:#b6b7bb; font-size:12px; padding:10px 6px}
.line-row .qty, .line-row .unit, .line-row .line{ text-align:center }
.line-row textarea{
  height:64px; /* bigger description box */
}
.small{font-size:12px; color:#aab}

/* Totals board */
.board{display:grid; gap:12px}
.row{
  display:flex; justify-content:space-between; align-items:center;
  background:#0d0f14; border:1px dashed #2a2a2a; padding:14px 16px; border-radius:12px;
}
.row.solid{border:2px solid #c9a840; background:#12110a}
.row .big{font-size:22px; font-weight:800}
.money{font-feature-settings:"tnum" 1; font-variant-numeric:tabular-nums}

/* Discount flash */
.flash-green{
  animation:flash 800ms ease;
}
@keyframes flash{ 0%{background:#0b3; color:#021} 100%{background:transparent; color:inherit} }

/* Signature */
.sig-wrap{border:2px dashed #c9a840; border-radius:12px; padding:12px; background:#0d0f14}
canvas#sig{width:100%; height:220px; background:#0a0c10; border-radius:10px}

/* Footer */
footer{margin:28px 0 60px; color:#b6b7bb; text-align:center}
hr.sep{border:none; border-top:1px solid #222; margin:22px 0}
.badge{display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid #3b3112; background:#20190a}
</style>
</head>
<body>
<div class="wrap">

  <!-- HEADER -->
  <header>
    <div class="head">
      <div class="brand">
        <!-- LOGO: make sure assets/warmupuk-logo.png exists -->
        <img src="assets/warmupuk-logo.png" alt="Warm Up UK Homes" onerror="this.style.display='none'">
        <div>
          <h1>WARM UP UK HOMES</h1>
          <small>Contract Builder</small>
        </div>
      </div>
      <div class="actions">
        <button id="btnPrint" class="btn gold">Print / Save PDF</button>
        <button id="btnWhatsApp" class="btn">Share via WhatsApp</button>
      </div>
    </div>
  </header>

  <!-- CONTRACT BODY (captured to PDF) -->
  <main id="contract" class="panel">

    <!-- Top meta -->
    <div class="grid" style="display:grid; gap:14px; grid-template-columns:1fr 1fr;">
      <div>
        <label>Contract Number</label>
        <input id="contractNo" class="input" readonly>
      </div>
      <div>
        <label>Date</label>
        <input id="contractDate" class="input" type="date">
      </div>
    </div>

    <hr class="sep">

    <h2 class="title">CLIENT &amp; JOB DETAILS</h2>
    <div class="grid" style="display:grid; gap:14px; grid-template-columns:1fr 1fr;">
      <div>
        <label>Client name</label>
        <input name="clientName" class="input" placeholder="Full name">
      </div>
      <div>
        <label>Contact number (WhatsApp)</label>
        <input id="clientPhone" class="input" placeholder="+44... or 07...">
      </div>
      <div style="grid-column:1 / -1">
        <label>Property address</label>
        <input id="address" class="input" placeholder="Address, Postcode">
      </div>
      <div>
        <label>Rep</label>
        <input id="rep" class="input" placeholder="Rep name">
      </div>
      <div>
        <label>Job type</label>
        <select id="jobType" class="input">
          <option>Loft Insulation</option>
          <option>Cavity Wall Insulation</option>
          <option>Underfloor Insulation</option>
          <option>Room in Roof</option>
          <option>Other</option>
        </select>
      </div>
      <div style="grid-column:1 / -1">
        <label>Date of install</label>
        <input id="installDate" class="input" type="date">
      </div>
    </div>

    <hr class="sep">

    <h2 class="title">PRODUCTS &amp; PRICING</h2>

    <!-- Lines head -->
    <div class="grid-head">
      <div>Description</div><div class="qty">Qty</div><div class="unit">Unit £</div><div class="line">Line £</div><div></div>
    </div>
    <div id="lines"></div>
    <div style="margin:12px 0">
      <button id="btnAdd" class="btn">+ Add line</button>
    </div>

    <div class="panel" style="margin:12px 0">
      <label class="small" style="display:flex; gap:10px; align-items:center;">
        <input id="applyVAT" type="checkbox" checked>
        Apply VAT (20%)
      </label>
      <div class="grid" style="display:grid; gap:10px; grid-template-columns:1fr 1fr;">
        <div>
          <label>Discount before VAT (£)</label>
          <input id="discountBefore" class="input" type="number" step="0.01" value="0">
        </div>
        <div>
          <label>Discount after VAT (£)</label>
          <input id="discountAfter" class="input" type="number" step="0.01" value="0">
        </div>
      </div>
    </div>

    <div class="board">
      <div class="row"><div>Subtotal</div><div id="subtotal" class="money">£0.00</div></div>
      <div class="row"><div>VAT (20%)</div><div id="vat" class="money">£0.00</div></div>
      <div class="row solid">
        <div class="big">Grand Total</div>
        <div id="grandTotal" class="money big">£0</div>
      </div>

      <div class="grid" style="display:grid; gap:12px; grid-template-columns:1fr 1fr;">
        <div class="row">
          <div>Deposit (paid / due now)</div>
          <input id="deposit" class="input" type="number" step="0.01" value="0" style="max-width:200px">
        </div>
        <div class="row">
          <div>Balance Due on Completion</div>
          <div id="balance" class="money">£0.00</div>
        </div>
      </div>

      <div class="row">
        <div class="big">Final to Pay Today</div>
        <div id="finalToday" class="money big">£0</div>
      </div>
    </div>

    <hr class="sep">

    <h2 class="title">NOTES / INSTRUCTIONS</h2>
    <textarea id="notes" placeholder="Write any installation notes or client instructions here..."></textarea>

    <hr class="sep">

    <h2 class="title">SIGNATURE</h2>
    <div class="sig-wrap">
      <canvas id="sig"></canvas>
      <div style="display:flex; gap:10px; margin-top:10px;">
        <button id="btnClearSig" class="btn">Clear</button>
        <span class="small">Client can sign above with finger or mouse.</span>
      </div>
    </div>

  </main>

  <footer>
    <div class="badge">Office: Fitzwilliam House, Middle Bank, Doncaster, England, DN4 5NG</div>
    <div style="margin-top:10px">Tel <a href="tel:07470474774">07470 474 774</a> · Email <a href="mailto:warmupuk@icloud.com">warmupuk@icloud.com</a></div>
  </footer>

</div>

<script>
/* ---------- Helpers ---------- */
const £ = n => `£${Number(n||0).toFixed(2)}`;
const byId = id => document.getElementById(id);
const fmt = new Intl.NumberFormat('en-GB', { style:'currency', currency:'GBP' });

/* ---------- Contract number + dates ---------- */
function genContractNo(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  const rand = Math.floor(1000+Math.random()*9000);
  return `WUUK-${y}${m}${day}-${rand}`;
}
function initMeta(){
  byId('contractNo').value = genContractNo();
  byId('contractDate').valueAsDate = new Date();
  byId('installDate').valueAsDate = new Date();
}

/* ---------- Lines (products) ---------- */
const linesEl = byId('lines');
function addLine(desc='', qty=1, unit=0){
  const row = document.createElement('div');
  row.className = 'line-row';
  row.innerHTML = `
    <textarea class="input desc" placeholder="e.g., Loft insulation — 100mm">${desc}</textarea>
    <input class="input qty" type="number" step="1" min="0" value="${qty}">
    <input class="input unit" type="number" step="0.01" min="0" value="${unit}">
    <input class="input line" type="number" step="0.01" min="0" value="0" readonly>
    <button class="btn del" title="Remove">×</button>
  `;
  linesEl.appendChild(row);

  const qtyEl = row.querySelector('.qty');
  const unitEl = row.querySelector('.unit');
  const lineEl = row.querySelector('.line');
  const delEl = row.querySelector('.del');

  const recalcLine = () => {
    const v = Number(qtyEl.value||0) * Number(unitEl.value||0);
    lineEl.value = v.toFixed(2);
    recalcTotals();
  };
  qtyEl.addEventListener('input', recalcLine);
  unitEl.addEventListener('input', recalcLine);
  delEl.addEventListener('click', () => { row.remove(); recalcTotals(); });

  recalcLine();
}
byId('btnAdd').addEventListener('click', () => addLine());

/* ---------- Totals / VAT / Discount ---------- */
function recalcTotals(flashEnd=false){
  // subtotal: sum of lines
  let subtotal = 0;
  document.querySelectorAll('.line-row').forEach(r=>{
    subtotal += Number(r.querySelector('.line').value||0);
  });

  // discounts
  const discBefore = Number(byId('discountBefore').value||0);
  const discAfter  = Number(byId('discountAfter').value||0);
  const applyVAT   = byId('applyVAT').checked;

  const base = Math.max(subtotal - discBefore, 0);
  const vat  = applyVAT ? base * 0.20 : 0;
  let grand  = Math.max(base + vat - discAfter, 0);

  byId('subtotal').textContent   = £(base);
  byId('vat').textContent        = £(vat);
  byId('grandTotal').textContent = £(grand);

  const deposit = Number(byId('deposit').value||0);
  const today   = Math.max(deposit, 0);
  const balance = Math.max(grand - deposit, 0);
  byId('finalToday').textContent = £(today);
  byId('balance').textContent    = £(balance);

  if (flashEnd){
    const gt = byId('grandTotal');
    gt.classList.remove('flash-green');
    void gt.offsetWidth; // restart animation
    gt.classList.add('flash-green');
  }
}
['discountBefore','discountAfter','applyVAT','deposit'].forEach(id=>{
  byId(id).addEventListener('input', ()=>{
    recalcTotals(id==='discountAfter'); // flash when final discount changes
  });
});

/* ---------- Signature pad ---------- */
const sigCanvas = byId('sig');
const ctx = sigCanvas.getContext('2d');
let drawing = false, signed = false, last = null;

function resizeCanvas(){
  const r = sigCanvas.getBoundingClientRect();
  const scale = window.devicePixelRatio || 1;
  sigCanvas.width = Math.floor(r.width * scale);
  sigCanvas.height = Math.floor(r.height * scale);
  ctx.scale(scale, scale);
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  ctx.lineWidth = 3;
  ctx.strokeStyle = '#ffd766';
  ctx.fillStyle = '#0a0c10';
  ctx.fillRect(0,0, r.width, r.height);
}
function pos(e){
  const rect = sigCanvas.getBoundingClientRect();
  const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
  const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
  return {x,y};
}
function start(e){ drawing=true; signed=true; last=pos(e); e.preventDefault();}
function move(e){
  if(!drawing) return;
  const p = pos(e);
  ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke();
  last = p; e.preventDefault();
}
function end(){ drawing=false; last=null; }

sigCanvas.addEventListener('mousedown', start);
sigCanvas.addEventListener('mousemove', move);
window.addEventListener('mouseup', end);
sigCanvas.addEventListener('touchstart', start, {passive:false});
sigCanvas.addEventListener('touchmove', move, {passive:false});
sigCanvas.addEventListener('touchend', end);

byId('btnClearSig').addEventListener('click', ()=>{ signed=false; resizeCanvas(); });

/* ---------- PDF + WhatsApp ---------- */
async function makePdfBlob(){
  const node = document.getElementById('contract');
  const canvas = await html2canvas(node, {scale:2, backgroundColor:'#0b0d12', useCORS:true});
  const img = canvas.toDataURL('image/jpeg', 0.95);

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({unit:'pt', format:'a4'});
  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();

  // Fit image to page width
  const ratio = canvas.height / canvas.width;
  const imgW = pageW, imgH = pageW * ratio;

  let y = 0;
  if(imgH <= pageH){
    pdf.addImage(img, 'JPEG', 0, 0, imgW, imgH);
  }else{
    // paginate
    let remaining = imgH;
    let sY = 0;
    const step = pageH;
    while(remaining > 0){
      pdf.addImage(img, 'JPEG', 0, y, imgW, imgH, undefined, 'FAST');
      remaining -= step;
      if(remaining > 0){ pdf.addPage(); }
    }
  }

  return pdf.output('blob');
}

async function shareWhatsApp(){
  if(!signed){
    alert('Please capture a signature before sharing.');
    return;
  }
  const client = document.querySelector('[name="clientName"]').value || 'Client';
  const total  = byId('grandTotal').textContent.trim();
  const no     = byId('contractNo').value;

  // Create PDF
  let blob;
  try{
    blob = await makePdfBlob();
  }catch(e){
    console.error(e);
    alert('Could not generate the PDF. You can still share the message.');
  }

  const msg = `WARM UP UK HOMES — Contract
No: ${no}
Client: ${client}
Total: ${total}`;

  // Try Web Share with file (mobile browsers that support it)
  if (blob && navigator.canShare && navigator.canShare({ files:[new File([blob],'Contract-'+no+'.pdf',{type:'application/pdf'})] })){
    const file = new File([blob], `Contract-${no}.pdf`, {type:'application/pdf'});
    try{
      await navigator.share({ text: msg, files:[file] });
      return;
    }catch(e){ /* fall through */ }
  }

  // Fallback: download PDF (if created) and open WhatsApp with prefilled text
  if (blob){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `Contract-${no}.pdf`; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 3000);
  }
  const wa = 'https://wa.me/?text=' + encodeURIComponent(msg + '\n(PDF saved—attach it to this chat)');
  window.open(wa, '_blank');
}

/* print/save button simply makes the PDF and downloads */
byId('btnPrint').addEventListener('click', async ()=>{
  const blob = await makePdfBlob();
  const no = byId('contractNo').value;
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `Contract-${no}.pdf`; a.click();
  setTimeout(()=>URL.revokeObjectURL(url), 3000);
});
byId('btnWhatsApp').addEventListener('click', shareWhatsApp);

/* ---------- Init ---------- */
function boot(){
  resizeCanvas();
  initMeta();
  addLine('Loft insulation — standard', 1, 0);
  recalcTotals();
}
window.addEventListener('resize', resizeCanvas);
window.addEventListener('load', boot);
</script>
</body>
</html>
