<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>WARM UP UK HOMES — Contract Builder</title>
<style>
:root{
  --bg:#0e0e0f; --panel:#151517; --ink:#f59e0b; --gold:#e6c24d; --text:#e6e6e6;
  --muted:#a1a1aa; --neon:#00ff7b;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.35 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Arial}
.wrap{max-width:940px;margin:18px auto 90px;padding:0 14px}
.hero{position:relative;background:linear-gradient(#18181a,#121214);border:1px solid #222;border-radius:18px;padding:16px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:12px;background:#000 url('assets/warmupuk-logo.png.PNG') center/cover no-repeat;border:1px solid #2a2a2a;box-shadow:inset 0 0 0 1px #000, 0 0 20px rgba(255,204,0,.08)}
.title{font-size:30px;font-weight:800}
.subtitle{color:var(--muted)}
.actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
.btn{appearance:none;border:1px solid #27272a;padding:12px 16px;border-radius:14px;font-weight:700;background:#1b1b1d;color:#fff;cursor:pointer}
.btn:active{transform:translateY(1px)}
.btn-gold{background:var(--gold);color:#18181b;border-color:#a68a1a}
.card{background:var(--panel);border:1px solid #232327;border-radius:18px;margin-top:14px;padding:16px}
.section-title{font-size:26px;font-weight:900;color:var(--gold);letter-spacing:.6px;margin:0 0 10px}
label{display:block;font-weight:700;margin:12px 0 8px}
input,select,textarea{width:100%;background:#0c0c0e;color:var(--text);border:2px solid var(--ink);border-radius:12px;padding:12px;outline:0}
input:focus,select:focus,textarea:focus{box-shadow:0 0 0 2px rgba(245,158,11,.35)}
textarea{min-height:100px;resize:vertical}
.grid{display:grid;gap:12px}
.g2{grid-template-columns:1fr 1fr}
.g3{grid-template-columns:2fr 1fr 1fr}
.g4{grid-template-columns:2fr .9fr 1fr 1fr}
@media (max-width:720px){.g2,.g3,.g4{grid-template-columns:1fr}}
.lines-head{display:grid;align-items:center;font-weight:800;color:#cbbb7a;padding:6px 10px;border-bottom:1px dashed #2e2e32}
.lines{display:grid;gap:10px;margin-top:10px}
.line{display:grid;gap:10px}
.line.g{grid-template-columns:2fr .9fr 1fr 1fr}
.pill{padding:12px;border-radius:14px;border:1px solid #2a2a2e;background:#101012;display:flex;justify-content:space-between;align-items:center;font-weight:700}
.sw{width:62px;height:36px;border-radius:36px;position:relative;background:#222;border:1px solid #333;cursor:pointer}
.sw i{position:absolute;top:3px;left:3px;width:30px;height:30px;border-radius:50%;background:#888;transition:.18s}
.sw.on{background:#0f3}.sw.on i{left:29px;background:#0a0}
.meta{display:grid;gap:12px;margin-top:14px}
.meta.g2{grid-template-columns:1fr 1fr}
.final{border:2px solid var(--ink);border-radius:16px;padding:14px 16px;background:#0e0e10;display:flex;justify-content:space-between;align-items:center;font-weight:900;font-size:20px}
.final.flash{animation:pulse 1s ease-in-out infinite alternate;box-shadow:0 0 12px 3px rgba(0,255,123,.45)}
@keyframes pulse{from{box-shadow:0 0 0 rgba(0,0,0,0)}to{box-shadow:0 0 12px 5px rgba(0,255,123,.55)}}
.sig-wrap{margin-top:14px;background:#0a0a0b;border:2px dashed var(--ink);border-radius:16px;padding:10px}
.sig-canvas{width:100%;height:240px;border-radius:10px;background:#000;touch-action:none}
.sig-actions{display:flex;gap:10px;margin-top:10px}
.note{color:#a1a1aa;font-size:13px;margin-top:6px}
.fixed-wa{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(90deg,#25d366,#128c7e);padding:12px 16px;display:flex;gap:10px;justify-content:center;border-top:1px solid #0a0a0a}
.fixed-wa .btn{background:transparent;border-color:rgba(255,255,255,.35)}
.currency{font-variant-numeric:tabular-nums}
.right{justify-self:end}
</style>
<script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="wrap" id="page">
    <header class="hero">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">WARM UP UK HOMES</div>
          <div class="subtitle">Contract Builder</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-gold" id="btnPdf">Save PDF</button>
        <button class="btn" id="btnWa">WhatsApp</button>
        <button class="btn" id="btnSave">Save quote to phone</button>
      </div>
    </header>

    <section class="card">
      <h2 class="section-title">CLIENT &amp; JOB DETAILS</h2>
      <div class="grid g2">
        <div><label>Contract Number</label><input id="contractNo" placeholder="WUUK-YYYYMMDD-XXXX"/></div>
        <div><label>Date</label><input id="date" type="date"/></div>
      </div>
      <div class="grid">
        <div><label>Client name</label><input id="client" placeholder="Full name"/></div>
        <div><label>Contact number (WhatsApp)</label><input id="whats" placeholder="+44... or 07…" inputmode="tel"/></div>
        <div><label>Property address</label><textarea id="address" placeholder="Address, Postcode"></textarea></div>
      </div>
    </section>

    <section class="card" id="pricing">
      <h2 class="section-title">PRODUCTS &amp; PRICING</h2>
      <div class="lines-head g4">
        <div>Product</div><div>Size (m)</div><div>Unit £/m</div><div class="right">Line £</div>
      </div>
      <div id="lines" class="lines"></div>
      <div class="actions" style="margin-top:10px"><button class="btn" id="addLine">+ Add line</button></div>

      <div class="meta g2">
        <div class="pill"><span>VAT (20%)</span><span class="sw on" id="vatSwitch"><i></i></span></div>
        <div class="pill"><span>Enable Discount</span><span class="sw" id="discSwitch"><i></i></span></div>
      </div>

      <div class="meta g2">
        <div class="pill"><span>Subtotal</span><span class="currency" id="subtotal">£0.00</span></div>
        <div class="pill"><span>VAT</span><span class="currency" id="vat">£0.00</span></div>
      </div>

      <div id="discountArea" style="display:none;margin-top:10px">
        <label class="subtitle" style="font-weight:800">Before / After (enter the two totals)</label>
        <div class="grid g2">
          <input id="discBefore" placeholder="Discount Before (£)" inputmode="decimal" type="number" step="any">
          <input id="discAfter"  placeholder="Discount After (£)"  inputmode="decimal" type="number" step="any">
        </div>
      </div>

      <div class="grid g2" style="margin-top:14px">
        <div>
          <label>Deposit (paid / due now)</label>
          <input id="deposit" value="0" inputmode="decimal" type="number" step="any">
        </div>
        <div class="final" id="finalCard"><span>Final to Pay Today</span><span class="currency" id="final">£0.00</span></div>
      </div>
    </section>

    <section class="card">
      <h2 class="section-title">Signature</h2>
      <div class="sig-wrap">
        <canvas id="sig" class="sig-canvas"></canvas>
        <div class="sig-actions"><button class="btn" id="clearSig">Clear</button></div>
        <div class="note">Sign inside the black box with your finger (orange ink).</div>
      </div>
    </section>
  </div>

  <!-- WhatsApp footer banner -->
  <div class="fixed-wa">
    <button class="btn" id="btnWaBottom">Send to WhatsApp</button>
  </div>

<script>
/* Helpers */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const money = n => "£" + (isFinite(n) ? (+n).toFixed(2) : "0.00");
const toNum = v => {
  if (v === null || v === undefined) return 0;
  const n = parseFloat(String(v).replace(/[^\d.-]/g,''));
  return isFinite(n) ? n : 0;
};

/* Contract number + date */
(function initMeta(){
  const d=new Date(), y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
  $('#date').value = `${y}-${m}-${dd}`;
  $('#contractNo').value = `WUUK-${y}${m}${dd}-${String(Math.floor(Math.random()*10000)).padStart(4,'0')}`;
})();

/* Lines */
const products = [
  {id:'spray',   label:'Spray Foam Removal'},
  {id:'ceiling', label:'Ceiling Level Insulation'},
  {id:'multifoil',label:'Multifoil'}
];

const linesEl = $('#lines');
function addLine(data={}){
  const row = document.createElement('div');
  row.className = 'line g';
  row.innerHTML = `
    <select class="prod">${products.map(p=>`<option value="${p.id}">${p.label}</option>`).join('')}</select>
    <input class="size" type="number" inputmode="decimal" step="any" placeholder="m" value="${data.size||''}">
    <input class="unit" type="number" inputmode="decimal" step="any" placeholder="£/m" value="${data.unit||''}">
    <input class="amt right" placeholder="£0.00" value="" readonly>
  `;
  linesEl.appendChild(row);
  ['input','change','keyup'].forEach(ev => row.addEventListener(ev, recalc));
  recalc();
}
$('#addLine').addEventListener('click', ()=>addLine());
addLine(); // first

/* Switches */
function makeSwitch(id, onChange){
  const el=$(id);
  const get=()=>el.classList.contains('on');
  el.addEventListener('click',()=>{el.classList.toggle('on'); onChange?.(get()); recalc();});
  return get;
}
const vatOn = makeSwitch('#vatSwitch');
const discOn = makeSwitch('#discSwitch',(on)=>{
  $('#discountArea').style.display = on ? '' : 'none';
  $('#finalCard').classList.toggle('flash', on);
});

/* Recalc */
function recalc(){
  let subtotal=0;
  $$('.line').forEach(r=>{
    const size = toNum(r.querySelector('.size').value);
    const unit = toNum(r.querySelector('.unit').value);
    const amt = size*unit;
    r.querySelector('.amt').value = money(amt);
    subtotal += amt;
  });
  const vatAmt = vatOn() ? subtotal*0.20 : 0;
  let discount = 0;
  if (discOn()){
    const before = toNum($('#discBefore').value);
    const after  = toNum($('#discAfter').value);
    discount = Math.max(0, before - after);
  }
  const dep = toNum($('#deposit').value);
  const final = Math.max(0, subtotal + vatAmt - discount - dep);

  $('#subtotal').textContent = money(subtotal);
  $('#vat').textContent      = money(vatAmt);
  $('#final').textContent    = money(final);
}
document.addEventListener('input', e=>{ if (e.target.closest('#pricing')) recalc(); });
document.addEventListener('change', e=>{ if (e.target.closest('#pricing')) recalc(); });
document.addEventListener('keyup',  e=>{ if (e.target.closest('#pricing')) recalc(); });

/* Signature (iPhone-safe) */
(function signature(){
  const cvs = $('#sig'), ctx = cvs.getContext('2d');
  function resize(){
    const r = cvs.getBoundingClientRect();
    const ratio = Math.max(1, window.devicePixelRatio || 1);
    cvs.width = r.width * ratio; cvs.height = r.height * ratio;
    ctx.setTransform(ratio,0,0,ratio,0,0);
    ctx.lineWidth = 3.2; ctx.lineCap = 'round';
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--ink').trim() || '#f59e0b';
    ctx.fillStyle = '#000'; ctx.fillRect(0,0,r.width,r.height);
  }
  resize(); addEventListener('resize', resize);
  let drawing=false,last=null;
  const pos = ev => {
    const p = ev.touches && ev.touches[0] ? ev.touches[0] : ev;
    const r = cvs.getBoundingClientRect();
    return {x:p.clientX - r.left, y:p.clientY - r.top};
  };
  const start = ev => { drawing=true; last=pos(ev); ev.preventDefault(); };
  const move  = ev => { if(!drawing) return; const p=pos(ev); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; ev.preventDefault(); };
  const end   = () => { drawing=false; };
  cvs.addEventListener('mousedown',start); addEventListener('mouseup',end); cvs.addEventListener('mousemove',move);
  cvs.addEventListener('touchstart',start,{passive:false}); cvs.addEventListener('touchend',end); cvs.addEventListener('touchmove',move,{passive:false});
  $('#clearSig').addEventListener('click', resize);
})();

/* Save locally */
$('#btnSave').addEventListener('click', ()=>{
  const data={
    contractNo:$('#contractNo').value,date:$('#date').value,client:$('#client').value,whats:$('#whats').value,address:$('#address').value,
    vatOn: $('#vatSwitch').classList.contains('on'), discOn: $('#discSwitch').classList.contains('on'),
    discBefore:$('#discBefore').value, discAfter:$('#discAfter').value, deposit:$('#deposit').value,
    lines: $$('.line').map(r=>({prod:r.querySelector('.prod').value, size:r.querySelector('.size').value, unit:r.querySelector('.unit').value}))
  };
  localStorage.setItem('wuuk-contract', JSON.stringify(data));
  alert('Saved to phone.');
});
(function loadSaved(){
  try{
    const d = JSON.parse(localStorage.getItem('wuuk-contract')||'null'); if(!d) return;
    $('#contractNo').value=d.contractNo||$('#contractNo').value;
    $('#date').value=d.date||$('#date').value; $('#client').value=d.client||''; $('#whats').value=d.whats||''; $('#address').value=d.address||'';
    $('#vatSwitch').classList.toggle('on', !!d.vatOn);
    $('#discSwitch').classList.toggle('on', !!d.discOn);
    $('#discountArea').style.display = d.discOn ? '' : 'none'; $('#finalCard').classList.toggle('flash', !!d.discOn);
    $('#discBefore').value=d.discBefore||''; $('#discAfter').value=d.discAfter||''; $('#deposit').value=d.deposit||'0';
    linesEl.innerHTML=''; (d.lines?.length?d.lines:[{}]).forEach(addLine);
  }catch(e){}
  recalc();
})();

/* WhatsApp */
function shareWhatsApp(){
  const msg = [
    'WARM UP UK HOMES — Quote',
    `Contract: ${$('#contractNo').value}`,
    `Client: ${$('#client').value}`,
    `Address: ${$('#address').value}`,
    `Final to Pay Today: ${$('#final').textContent}`
  ].join('\n');
  const phone = $('#whats').value.trim();
  const encoded = encodeURIComponent(msg);
  const url = phone ? `https://wa.me/${phone.replace(/[^\d]/g,'')}?text=${encoded}` : `https://wa.me/?text=${encoded}`;
  if (navigator.share){ navigator.share({text:msg}).catch(()=>window.open(url,'_blank')); }
  else { window.open(url,'_blank'); }
}
$('#btnWa').addEventListener('click', shareWhatsApp);
$('#btnWaBottom').addEventListener('click', shareWhatsApp);

/* Save PDF */
$('#btnPdf').addEventListener('click', async ()=>{
  const { jsPDF } = window.jspdf || {};
  if (!jsPDF){ alert('PDF library not loaded.'); return; }
  const node = document.getElementById('page');
  const canvas = await html2canvas(node,{scale:2,useCORS:true,backgroundColor:'#0e0e0f'});
  const img = canvas.toDataURL('image/png');
  const pdf = new jsPDF({unit:'pt',format:'a4',compress:true});
  const pageW = pdf.internal.pageSize.getWidth(), pageH = pdf.internal.pageSize.getHeight();
  const ratio = Math.min(pageW/canvas.width, pageH/canvas.height);
  const w = canvas.width*ratio, h = canvas.height*ratio, x=(pageW-w)/2, y=20;
  pdf.addImage(img,'PNG',x,y,w,h,'','FAST');
  pdf.save(`${$('#contractNo').value||'contract'}.pdf`);
});

/* Final safety: recalc on page show (iOS bfcache) */
window.addEventListener('pageshow', recalc);
</script>
</body>
</html>
