<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Warm Up UK · Contract</title>

<style>
  :root{--bg:#0f0f10;--card:#1c1c1f;--text:#f5f5f5;--muted:#b9b9b9;--brand:#d4af37}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Arial,sans-serif}
  a{color:var(--brand)}
  header{max-width:900px;margin:20px auto 0;padding:0 16px}
  .nav{margin:6px 0 14px;font-size:14px}
  .nav a{margin-right:12px;text-decoration:none}
  .wrap{max-width:900px;margin:0 auto 60px;padding:16px}
  .card{background:var(--card);border-radius:12px;padding:16px}
  h1{margin:6px 0 14px;color:var(--brand)}
  h2{margin:16px 0 10px}
  .logoRow{display:flex;align-items:center;gap:14px;margin-bottom:10px}
  .logoRow img{height:50px;background:#fff;border-radius:6px}
  .muted{color:var(--muted);font-size:12px}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .box{flex:1;min-width:260px;background:#0b0b0d;border:1px solid #2d2d31;border-radius:10px;padding:12px}
  .line{height:1px;background:#2d2d31;margin:14px 0}
  .kv{display:grid;grid-template-columns:160px 1fr;gap:8px 10px}
  .kv div{min-height:22px}
  .sigWrap{background:#0b0b0d;border:1px solid #2d2d31;border-radius:10px;padding:10px}
  canvas{background:#fff;border-radius:6px;width:100%;height:180px;touch-action:none}
  .btns{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px}
  .btn{padding:12px;border:none;border-radius:10px;font-weight:700;cursor:pointer}
  .btn-primary{background:var(--brand);color:#131313}
  .btn-ghost{background:#2a2a2e;color:var(--text)}
  @media (max-width:720px){.btns{grid-template-columns:1fr}}
</style>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
</head>
<body>

<header>
  <div class="nav">
    <a href="index.html">Dashboard</a> ·
    <a href="calendar.html">Calendar</a> ·
    <strong>Contract</strong> ·
    <a href="order-form.html">Order Form</a>
  </div>
  <div class="logoRow">
    <img id="brandLogo" src="WUUK.JPG" alt="Warm Up UK logo"/>
    <div>
      <div style="font-weight:800;letter-spacing:.5px">WARM UP UK</div>
      <div class="muted">Contract & Authorisation</div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <h1>Contract</h1>

    <div class="row">
      <div class="box">
        <h2 style="margin-top:0">Customer</h2>
        <div class="kv">
          <div class="muted">Name</div><div id="vName">-</div>
          <div class="muted">Phone</div><div id="vPhone">-</div>
          <div class="muted">Address</div><div id="vAddress">-</div>
          <div class="muted">Email</div><div id="vEmail">-</div>
        </div>
      </div>
      <div class="box">
        <h2 style="margin-top:0">Work</h2>
        <div class="kv">
          <div class="muted">Date</div><div id="vDate">-</div>
          <div class="muted">Product/Service</div><div id="vProduct">-</div>
          <div class="muted">Price</div><div id="vPrice">-</div>
          <div class="muted">Notes</div><div id="vNotes">-</div>
        </div>
      </div>
    </div>

    <div class="line"></div>

    <div class="muted" style="line-height:1.5">
      By signing below, the client authorises Warm Up UK to carry out the works described and agrees to the quoted price and standard terms.
    </div>

    <h2>Client Signature</h2>
    <div class="sigWrap">
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn btn-ghost" id="clearSig" type="button">Clear</button>
      </div>
      <canvas id="sigCanvas" height="180"></canvas>
    </div>

    <div class="btns">
      <button class="btn btn-primary" id="btnPdf">Create & Download PDF</button>
      <button class="btn btn-ghost" id="btnPreview">Preview PDF</button>
    </div>
  </div>
</div>

<script>
  // --- read URL params ---
  const params = new URLSearchParams(location.search);
  function get(k, d=''){ return params.get(k) ? decodeURIComponent(params.get(k)) : d; }

  const data = {
    name:   get('name'),
    phone:  get('phone'),
    email:  get('email'),
    address:get('address'),
    date:   get('date'),
    product:get('product'),
    price:  get('price'),
    notes:  get('notes')
  };

  // fill UI
  const set = (id, v) => document.getElementById(id).textContent = v || '-';
  set('vName', data.name);
  set('vPhone', data.phone);
  set('vEmail', data.email);
  set('vAddress', data.address);
  set('vDate', data.date);
  set('vProduct', data.product);
  set('vPrice', data.price ? `£${Number(data.price).toFixed(2)}` : '-');
  set('vNotes', data.notes);

  // signature pad
  const canvas = document.getElementById('sigCanvas');
  function fitCanvas(){
    const ratio = Math.max(window.devicePixelRatio||1,1);
    const w = canvas.clientWidth;
    const h = canvas.clientHeight;
    canvas.width = w*ratio; canvas.height = h*ratio;
    canvas.getContext('2d').scale(ratio,ratio);
  }
  fitCanvas(); window.addEventListener('resize', fitCanvas);

  const sigPad = new SignaturePad.SignaturePad(canvas, { backgroundColor:'white', penColor:'black' });
  document.getElementById('clearSig').onclick = () => sigPad.clear();

  // logo to embed in PDF
  let logoDataUrl = null;
  (function loadLogo(){
    const img = document.getElementById('brandLogo');
    img.onload = () => {
      try {
        const c = document.createElement('canvas');
        const w = Math.min(220, img.naturalWidth);
        const h = img.naturalHeight * (w/img.naturalWidth);
        c.width=w; c.height=h;
        const ctx=c.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,w,h);
        ctx.drawImage(img,0,0,w,h);
        logoDataUrl = c.toDataURL('image/jpeg',0.92);
      } catch(e){ logoDataUrl = null; }
    };
  })();

  async function buildPDF(preview=false){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'pt',format:'a4'});
    const margin = 40; let y = margin;

    if (logoDataUrl) doc.addImage(logoDataUrl,'JPEG',margin,y,130,38);
    doc.setFont('helvetica','bold'); doc.setFontSize(18);
    doc.text('Contract / Authorisation', 595 - margin, y+22, {align:'right'});
    doc.setFontSize(10); doc.setFont('helvetica','normal');
    doc.text('Warm Up UK', 595 - margin, y+36, {align:'right'});
    y+=60;

    doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.text('Customer', margin, y); y+=14;
    doc.setFont('helvetica','normal'); doc.setFontSize(11);
    doc.text(`Name: ${data.name||'-'}`, margin, y); y+=14;
    doc.text(`Phone: ${data.phone||'-'}`, margin, y); y+=14;
    doc.text(`Email: ${data.email||'-'}`, margin, y); y+=14;
    doc.text(`Address: ${data.address||'-'}`, margin, y); y+=18;

    doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.text('Work', margin, y); y+=14;
    doc.setFont('helvetica','normal'); doc.setFontSize(11);
    doc.text(`Date: ${data.date||'-'}`, margin, y); y+=14;
    doc.text(`Product/Service: ${data.product||'-'}`, margin, y); y+=14;
    doc.text(`Price: ${data.price ? '£'+Number(data.price).toFixed(2) : '-'}`, margin, y); y+=18;

    if (data.notes){
      doc.setFont('helvetica','bold'); doc.text('Notes', margin, y); y+=14;
      doc.setFont('helvetica','normal');
      const t = doc.splitTextToSize(data.notes, 595 - margin*2);
      doc.text(t, margin, y);
      y += t.length*14 + 10;
    }

    if (!sigPad.isEmpty()){
      doc.setFont('helvetica','bold'); doc.text('Client signature', margin, y); y+=10;
      doc.addImage(sigPad.toDataURL('image/png'),'PNG', margin, y, 240, 60);
      y += 70;
    } else {
      doc.setFont('helvetica','bold'); doc.text('Client signature: (not provided)', margin, y); y+=20;
    }

    doc.setDrawColor(210); doc.line(margin, 820, 595 - margin, 820);
    doc.setFontSize(9); doc.setTextColor(120);
    doc.text('This PDF was generated electronically by Warm Up UK.', 595/2, 834, {align:'center'});

    const fileName = `WUUK_Contract_${(data.name||'Client').replace(/\s+/g,'_')}.pdf`;
    if (preview){
      const url = doc.output('bloburl');
      const w = window.open(url,'_blank'); if(!w) doc.save(fileName);
    } else {
      doc.save(fileName);
    }
  }

  document.getElementById('btnPdf')?.addEventListener('click',()=>buildPDF(false));
  document.getElementById('btnPreview')?.addEventListener('click',()=>buildPDF(true));
</script>

<!-- action buttons anchored at bottom of card -->
<div class="wrap" style="margin-top:-44px">
  <div class="card" style="padding-top:8px">
    <div class="btns">
      <button class="btn btn-primary" id="btnPdf">Create & Download PDF</button>
      <button class="btn btn-ghost" id="btnPreview">Preview PDF</button>
    </div>
  </div>
</div>

</body>
</html>
