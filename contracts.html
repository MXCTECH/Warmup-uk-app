<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Warm Up UK Homes — Contract Builder</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<style>
  :root{
    --bg:#0b0d12; --panel:#12141b; --soft:#1a1d26; --ink:#e8e8ea;
    --muted:#a9acb3; --gold:#d4af37; --gold-2:#947d22; --ok:#00ff66;
    --warn:#ffcc00; --red:#ff5a5a;
    --ring: 0 0 0 3px rgba(212,175,55,.25);
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    color:var(--ink); background:#050609 radial-gradient(1200px 600px at 50% -20%, #2e2610 0%, transparent 60%) no-repeat;
  }

  /* Floating banner */
  .banner{
    position:sticky; top:0; z-index:5;
    margin:18px auto 10px; max-width:980px;
    background: linear-gradient(180deg,#3b2e0e,#19150a);
    border:1px solid rgba(212,175,55,.35);
    border-radius:20px; padding:18px 18px 14px;
    box-shadow: 0 10px 40px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.05);
    overflow:hidden;
    animation: floatDown .6s ease-out both;
  }
  @keyframes floatDown{from{transform:translateY(-16px); opacity:.0} to{transform:none; opacity:1}}
  .banner-row{display:flex; gap:16px; align-items:center; justify-content:space-between}
  .brand{display:flex; gap:14px; align-items:center}
  #logo{width:56px; height:56px; object-fit:contain; border-radius:12px; background:#111; border:1px solid rgba(255,255,255,.08)}
  .title h1{margin:0; letter-spacing:.08em; font-weight:800; font-size:24px}
  .title p{margin:3px 0 0; color:var(--muted)}
  .cta{display:flex; gap:12px; flex-wrap:wrap}
  .btn{
    appearance:none; border:1px solid rgba(212,175,55,.6); color:#101114; font-weight:700;
    background:linear-gradient(#ffdf7a,#d4af37); padding:10px 16px; border-radius:14px; cursor:pointer;
  }
  .btn.ghost{
    background:transparent; color:var(--ink); border-color:rgba(212,175,55,.5);
  }
  .btn:active{transform:translateY(1px)}
  .btn:focus{outline:none; box-shadow:var(--ring)}

  /* Card & form items */
  .wrap{max-width:980px; margin:0 auto 80px; padding:0 14px 40px}
  .card{
    background:var(--panel); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius);
    padding:18px; margin:16px 0; box-shadow: 0 6px 30px rgba(0,0,0,.35);
  }
  h2.section{margin:8px 0 16px; color:var(--gold); letter-spacing:.12em; font-weight:900; text-transform:uppercase}

  .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:12px}
  .field{grid-column:span 12}
  @media(min-width:680px){
    .field.h6{grid-column:span 6}
    .field.h4{grid-column:span 4}
    .field.h3{grid-column:span 3}
  }
  label{display:block; margin:0 0 6px; color:var(--muted); font-weight:600}
  input,select,textarea{
    width:100%; background:var(--soft); color:var(--ink);
    border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px 14px;
  }
  input:focus,select:focus,textarea:focus{outline:none; box-shadow:var(--ring); border-color:var(--gold)}
  textarea{min-height:120px; resize:vertical}

  /* Products table */
  .table-head, .row{display:grid; grid-template-columns: 5fr 1fr 2fr 2fr auto; gap:10px; align-items:center}
  .row + .row{margin-top:8px}
  .pill{border:1px dashed rgba(255,255,255,.15); border-radius:14px; padding:10px 14px; color:var(--muted)}
  .smallbtn{background:#141721; border:1px solid rgba(255,255,255,.1); color:#fff; border-radius:10px; padding:9px 12px; cursor:pointer}
  .smallbtn.danger{border-color:rgba(255,90,90,.4); color:#ff9b9b}

  .totals{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .totalbox{
    background:#0c0f16; border:1px dashed rgba(255,255,255,.15); border-radius:16px; padding:14px;
  }
  .totalbox .big{font-size:22px; font-weight:800}
  .grand{border:2px solid var(--gold); background:linear-gradient(180deg, #19150a, #0c0a05)}
  .final.flash{animation:flash 1.2s ease-in-out infinite}
  @keyframes flash { 0%,100%{background:#0c0f16} 50%{background:rgba(0,255,102,.22)}}

  /* Discount toggle + flashing boxes */
  .toggle{
    --h:22px; display:inline-flex; align-items:center; gap:10px; user-select:none; cursor:pointer;
  }
  .switch{width:44px; height:var(--h); background:#2a2f3b; border-radius:999px; position:relative; border:1px solid rgba(255,255,255,.1)}
  .knob{position:absolute; top:1px; left:1px; width:var(--h); height:var(--h); border-radius:50%; background:#fff; transition:.2s}
  .on .switch{background:#0f3}
  .on .knob{left:calc(44px - var(--h) - 1px)}
  .flash-green{animation:glow 1s ease-in-out infinite}
  @keyframes glow{0%,100%{box-shadow:0 0 0 0 rgba(0,255,102,.0)}50%{box-shadow:0 0 0 8px rgba(0,255,102,.18)}}

  /* Signature */
  .sigpad{background:#fff; border:2px dashed var(--gold); border-radius:14px; height:200px; touch-action:none}
  .sig-actions{display:flex; gap:10px; margin-top:8px}

  /* Footer mode */
  .footer{
    margin:16px auto 0; max-width:980px; padding:14px; color:#b7bbc4; display:flex;
    justify-content:space-between; gap:12px; align-items:center; opacity:.9
  }
</style>
</head>
<body>

  <!-- Banner -->
  <header class="banner">
    <div class="banner-row">
      <div class="brand">
        <img id="logo" src="assets/warmupuk-logo.png.PNG" alt="Warm Up UK Homes logo" />
        <div class="title">
          <h1>WARM UP UK HOMES</h1>
          <p>Contract Builder · Black &amp; Gold Theme</p>
        </div>
      </div>
      <div class="cta">
        <button id="btnPDF" class="btn">Print / Save PDF</button>
        <button id="btnWA" class="btn ghost">Share via WhatsApp</button>
      </div>
    </div>
  </header>

  <main class="wrap">

    <!-- Contract meta -->
    <section class="card">
      <h2 class="section">Contract & Client</h2>
      <div class="grid">
        <div class="field h6">
          <label>Contract Number</label>
          <input id="contractNo" placeholder="WUUK-YYYYMMDD-XXXX" readonly>
        </div>
        <div class="field h6">
          <label>Date</label>
          <input id="date" type="date">
        </div>
        <div class="field h6">
          <label>Client name</label>
          <input id="client" placeholder="Full name">
        </div>
        <div class="field h6">
          <label>Client address</label>
          <input id="address" placeholder="Address, Postcode">
        </div>
        <div class="field h6">
          <label>Contact number (WhatsApp)</label>
          <input id="phone" placeholder="+44… or 07…">
        </div>
        <div class="field h6">
          <label>Rep</label>
          <input id="rep" placeholder="Rep name">
        </div>
      </div>
    </section>

    <!-- Products -->
    <section class="card">
      <h2 class="section">Products & Pricing</h2>

      <div class="table-head pill" style="margin-bottom:8px">
        <div>Description</div><div>Qty</div><div>Unit £</div><div>Line £</div><div></div>
      </div>

      <div id="lines"></div>

      <div style="margin-top:12px; display:flex; gap:10px;">
        <button class="smallbtn" id="addLine">+ Add line</button>
        <label class="toggle" id="discountToggle">
          <span>Discounts</span>
          <span class="switch"><span class="knob"></span></span>
        </label>
        <label class="toggle" id="vatToggle">
          <span>Apply VAT (20%)</span>
          <span class="switch"><span class="knob"></span></span>
        </label>
      </div>

      <div id="discountArea" class="grid" style="margin-top:10px; display:none;">
        <div class="field h6">
          <label>Discount Before (£)</label>
          <input id="discBefore" inputmode="decimal" value="0">
        </div>
        <div class="field h6">
          <label>Discount After (£)</label>
          <input id="discAfter" inputmode="decimal" value="0">
        </div>
      </div>

      <div class="grid" style="margin-top:16px;">
        <div class="field h6 totalbox">
          <div style="display:flex;justify-content:space-between;">
            <span>Subtotal</span><span class="big" id="subTot">£0</span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:6px;">
            <span>VAT (20%)</span><span id="vatVal">£0</span>
          </div>
        </div>
        <div class="field h6 totalbox grand final" id="finalBox">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <span class="big">Final to Pay Today</span><span class="big" id="grand">£0</span>
          </div>
        </div>
        <div class="field h6 totalbox">
          <label>Deposit (£)</label>
          <input id="deposit" inputmode="decimal" value="0">
        </div>
        <div class="field h6 totalbox">
          <label>Total Price (£)</label>
          <input id="totalPrice" inputmode="decimal" value="0">
        </div>
      </div>
    </section>

    <!-- Notes + Signature -->
    <section class="card">
      <h2 class="section">Notes & Signature</h2>
      <div class="grid">
        <div class="field">
          <label>Notes / Special Instructions</label>
          <textarea id="notes" placeholder="Installation details, access notes, etc."></textarea>
        </div>

        <div class="field">
          <label>Signature</label>
          <canvas id="sig" class="sigpad"></canvas>
          <div class="sig-actions">
            <button class="smallbtn" id="clearSig">Clear signature</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer controls -->
    <div class="footer">
      <div>
        <strong>Store mode:</strong>
        <select id="storeMode">
          <option>Home visit</option>
          <option>Online</option>
          <option>Phone sale</option>
        </select>
      </div>
      <div>© Warm Up UK Homes</div>
    </div>

  </main>

<!-- libs for PDF -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
(() => {
  const $, $$ = (q,ctx=document)=>ctx.querySelector(q), (qq,ctx=document)=>[...ctx.querySelectorAll(qq)];
  const fmt = n => '£'+(Number(n||0)).toLocaleString('en-GB',{minimumFractionDigits:2,maximumFractionDigits:2});
  const num = v => Math.max(0, Number(String(v).replace(/[^0-9.]/g,'')) || 0);

  /* Contract number + date */
  const pad4 = n => String(n).padStart(4,'0');
  const genNo = () => {
    const d = new Date();
    const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
    const rnd = pad4(Math.floor(Math.random()*10000));
    return `WUUK-${y}${m}${dd}-${rnd}`;
  };
  $('#contractNo').value = genNo();
  $('#date').valueAsDate = new Date();

  /* Rows */
  const linesWrap = $('#lines');
  const makeRow = (desc='Loft insulation — standard', qty=1, unit=0) => {
    const r = document.createElement('div');
    r.className='row';
    r.innerHTML = `
      <input class="desc" placeholder="e.g., Loft insulation" value="${desc}">
      <input class="qty" inputmode="numeric" value="${qty}">
      <input class="unit" inputmode="decimal" value="${unit}">
      <input class="line" value="0.00" readonly>
      <button class="smallbtn danger remove">×</button>`;
    linesWrap.appendChild(r);
    bindRow(r); calc();
  };
  const bindRow = (r) => {
    const qty = $('.qty',r), unit=$('.unit',r), line=$('.line',r);
    const on = ()=>{ line.value = (num(qty.value)*num(unit.value)).toFixed(2); calc(); };
    qty.addEventListener('input', on); unit.addEventListener('input', on);
    $('.remove',r).addEventListener('click', ()=>{ r.remove(); calc(); });
    on();
  };
  $('#addLine').addEventListener('click', ()=>makeRow('',1,0));
  makeRow(); // initial row

  /* Toggles */
  const toggle = (wrap, onChange) => {
    wrap.addEventListener('click', ()=>{ wrap.classList.toggle('on'); onChange?.(); });
    return { get:()=>wrap.classList.contains('on') };
  };
  const discT = toggle($('#discountToggle'), ()=>{
    const on = $('#discountToggle').classList.contains('on');
    $('#discountArea').style.display = on ? 'grid' : 'none';
    ['#discBefore','#discAfter'].forEach(sel=>{
      const el=$(sel); if(on){ el.classList.add('flash-green'); } else { el.classList.remove('flash-green'); el.value='0'; }
    });
    calc();
  });
  const vatT = toggle($('#vatToggle'), calc);

  ['#discBefore','#discAfter','#deposit','#totalPrice'].forEach(sel=>{
    $(sel).addEventListener('input', ()=>{ if(discT.get() && (sel.includes('disc'))) $('#finalBox').classList.add('flash'); calc(); });
    $(sel).addEventListener('blur', ()=>$('#finalBox').classList.remove('flash'));
  });

  function calc(){
    const lines = $$('.row');
    const subtotal = lines.reduce((s,r)=> s + num($('.line',r).value), 0);
    let vat = vatT.get() ? subtotal*0.20 : 0;
    const before = discT.get()? num($('#discBefore').value):0;
    const after  = discT.get()? num($('#discAfter').value):0;
    const deposit= num($('#deposit').value);
    let total = subtotal - before + vat - after;
    if(total<0) total=0;
    $('#subTot').textContent = fmt(subtotal);
    $('#vatVal').textContent = fmt(vat);
    $('#grand').textContent = fmt(Math.max(0,total - deposit));
    $('#totalPrice').value = total.toFixed(2);
  }

  /* Signature pad (simple) */
  const sig = $('#sig'); const ctx = sig.getContext('2d'); let drawing=false, prev=null;
  const setSize = ()=>{ const r=sig.getBoundingClientRect(); const dpr=window.devicePixelRatio||1; sig.width=r.width*dpr; sig.height=r.height*dpr; ctx.scale(dpr,dpr); ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#000'; ctx.fillStyle='#fff'; ctx.fillRect(0,0,r.width,r.height); };
  const pos = e => { const t=sig.getBoundingClientRect(); const p = e.touches? e.touches[0]: e; return {x:p.clientX-t.left, y:p.clientY-t.top}; };
  const draw = e => { if(!drawing) return; const p=pos(e); ctx.beginPath(); ctx.moveTo(prev.x,prev.y); ctx.lineTo(p.x,p.y); ctx.stroke(); prev=p; e.preventDefault(); };
  const start = e => { drawing=true; prev=pos(e); e.preventDefault(); };
  const end = ()=> drawing=false;
  window.addEventListener('resize', setSize); setSize();
  sig.addEventListener('mousedown', start); sig.addEventListener('mousemove', draw); window.addEventListener('mouseup', end);
  sig.addEventListener('touchstart', start, {passive:false}); sig.addEventListener('touchmove', draw, {passive:false}); window.addEventListener('touchend', end);
  $('#clearSig').addEventListener('click', setSize);

  /* PDF + WhatsApp */
  async function makePDF(){
    // temporarily stop banner sticky to capture nicely
    const banner = document.querySelector('.banner'); const oldPos=banner.style.position; banner.style.position='static';
    const node = document.body;
    const canvas = await html2canvas(node, {scale:2, background:'#ffffff'});
    const img = canvas.toDataURL('image/jpeg', .95);
    const pdf = new jspdf.jsPDF('p','pt','a4');
    const pageW = pdf.internal.pageSize.getWidth(), pageH = pdf.internal.pageSize.getHeight();
    // fit image full width
    const imgW = pageW, imgH = canvas.height * (pageW / canvas.width);
    let y = 0; let left = 0;
    if(imgH <= pageH){ pdf.addImage(img, 'JPEG', left, y, imgW, imgH); }
    else{
      let sH = pageH;
      let heightLeft = imgH;
      let position = 0;
      pdf.addImage(img, 'JPEG', left, position, imgW, imgH);
      heightLeft -= pageH;
      while(heightLeft > -pageH){
        position = heightLeft - imgH;
        pdf.addPage();
        pdf.addImage(img, 'JPEG', left, position, imgW, imgH);
        heightLeft -= pageH;
      }
    }
    banner.style.position=oldPos;
    return pdf;
  }

  $('#btnPDF').addEventListener('click', async ()=>{
    const pdf = await makePDF();
    pdf.save(`${$('#contractNo').value}.pdf`);
  });

  $('#btnWA').addEventListener('click', async ()=>{
    const pdf = await makePDF();
    const blob = pdf.output('blob');
    const file = new File([blob], `${$('#contractNo').value}.pdf`, {type:'application/pdf'});
    const summary =
`WARM UP UK HOMES
Contract: ${$('#contractNo').value}
Client: ${$('#client').value || '-'}
Address: ${$('#address').value || '-'}
Total: ${$('#totalPrice').value ? fmt($('#totalPrice').value) : $('#grand').textContent}`;

    // Try share sheet (best on mobile)
    if(navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({files:[file], title:'Contract PDF', text:summary});
    }else{
      // Fallback: open WhatsApp text (file attach not guaranteed on iOS Safari)
      const url = 'https://wa.me/?text=' + encodeURIComponent(summary);
      window.open(url,'_blank');
    }
  });

  // recalc on any change
  document.addEventListener('input', e=>{
    if(['INPUT','SELECT','TEXTAREA'].includes(e.target.tagName)) calc();
  });

})();
</script>
</body>
</html>
