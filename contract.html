<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MXCTECH INSULATION — Contract</title>
<style>
  :root{--bg:#0c0f16;--panel:#171b23;--panel2:#10141c;--line:#232936;--text:#e9edf7;--muted:#9aa4bd;--blue:#1F6BFF;--red:#E53935;--green:#17a56a;}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0d14,#0b0e15 60%,#0c0f16);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;display:flex;gap:12px;align-items:center;padding:14px 16px;background:rgba(16,20,28,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  header img{height:36px;border-radius:6px}
  header h1{margin:0;font-size:18px;font-weight:900}
  main{max-width:1000px;margin:auto;padding:16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 8px 26px rgba(0,0,0,.25)}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  label{color:var(--muted);font-size:12px;margin:2px 0 6px;display:block}
  input,select,textarea{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:var(--panel2);color:var(--text);font-size:15px}
  textarea{grid-column:1/-1;min-height:80px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{border:1px solid var(--line);background:var(--panel2);color:var(--text);padding:10px 14px;border-radius:10px;font-weight:900;cursor:pointer}
  .btn.primary{background:var(--blue);border-color:var(--blue)}
  .btn.green{background:var(--green);border-color:var(--green)}
  .btn.red{background:var(--red);border-color:var(--red)}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
  th{color:var(--muted);font-size:12px;text-transform:uppercase}
  canvas{border:1px dashed #2b3146;border-radius:10px;background:#0c101a}
  @media (max-width:900px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <img src="mxctech-logo.png" alt="MXCTECH logo"/>
  <h1>Customer Contract</h1>
</header>

<main id="contractArea">
  <div class="card">
    <div class="grid">
      <div><label>Contract No.</label><input id="contractNo" readonly placeholder="Generated on save"/></div>
      <div><label>Job Type</label><input id="jobType"/></div>
      <div><label>Install Date</label><input id="installDate" type="date"/></div>

      <div><label>Customer Name</label><input id="custName"/></div>
      <div><label>Phone</label><input id="custPhone"/></div>
      <div><label>Email</label><input id="custEmail"/></div>

      <div><label>Address</label><input id="addr1"/></div>
      <div><label>Postcode</label><input id="postcode"/></div>
      <div><label>Appointment Date/Time</label><input id="apptDate" type="datetime-local"/></div>

      <div><label>Rep Name</label><input id="repName"/></div>
      <div><label>Booking Agent</label><input id="bookingAgent" placeholder="(fill)"/></div>
      <div><label>Confirmer</label><input id="confirmer" placeholder="(fill)"/></div>

      <textarea id="notes" placeholder="Contract notes…"></textarea>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">Products / Pricing</h3>
    <div class="row" style="margin-bottom:8px">
      <select id="itemName">
        <option>Multifoil Insulation</option><option>Spray Foam Removal</option>
        <option>Loft Boarding</option><option>Ventilation</option><option>Other</option>
      </select>
      <input id="qty" type="number" min="1" value="1" placeholder="Qty"/>
      <input id="price" type="number" step="0.01" placeholder="Unit Price (£)"/>
      <button class="btn green" id="addItem">Add Item</button>
      <label class="row" style="margin-left:auto;gap:8px">
        <input id="vatOn" type="checkbox" checked style="transform:scale(1.2)"/> Apply VAT (20%)
      </label>
    </div>
    <table id="itemsTable">
      <thead><tr><th>Item</th><th>Qty</th><th>Unit (£)</th><th>Line (£)</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div style="display:flex;gap:12px;justify-content:flex-end;flex-wrap:wrap;margin-top:10px">
      <div class="btn">Subtotal: £<span id="subtotal">0.00</span></div>
      <div class="btn">VAT: £<span id="vat">0.00</span></div>
      <div class="btn primary">Total: £<span id="total">0.00</span></div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">Signature</h3>
    <canvas id="sig" width="800" height="220"></canvas>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="clearSig">Clear</button>
    </div>
  </div>

  <div class="row" style="justify-content:flex-end">
    <button class="btn primary" id="saveContract">Save Contract</button>
    <button class="btn" id="downloadPDF">Download PDF</button>
    <a class="btn red" id="backDash" href="dashboard.html" style="text-decoration:none">Back to Dashboard</a>
  </div>

  <p class="card" style="font-size:12px;color:#9aa4bd">
    By signing, the customer agrees to the specification and total shown above. Cooling-off rights and scheduling are subject to MXCTECH INSULATION terms.
  </p>
</main>

<!-- PDF libs -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
const $=s=>document.querySelector(s); const load=(k,d=[])=>JSON.parse(localStorage.getItem(k)||JSON.stringify(d)); const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const fmt=n=>Number(n||0).toFixed(2);

/* Prefill from query or saved id */
(function(){
  const q=new URLSearchParams(location.search); const openId=q.get('id');
  if(openId){
    const c=load('mxc_contracts').find(x=>x.id===openId);
    if(c){ fillFromObject(c); items=c.items||[]; renderItems(); if(c.signatureData) loadSignature(c.signatureData); calcTotals(); }
    return;
  }
  ['custName','custPhone','custEmail','addr1','postcode','apptDate','repName','jobType','notes'].forEach(k=>{ const el=$('#'+k); if(el) el.value=q.get(k)||''; });
})();

function fillFromObject(c){
  Object.entries(c).forEach(([k,v])=>{ const el=$('#'+k); if(el) el.value=v; });
  $('#contractNo').value=c.contractNo||'';
}

/* Items */
let items=[];
function renderItems(){
  const tb=$('#itemsTable tbody'); tb.innerHTML='';
  items.forEach((it,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${it.name}</td><td>${it.qty}</td><td>£${fmt(it.price)}</td><td>£${fmt(it.qty*it.price)}</td>
      <td><button class="btn red" onclick="removeItem(${i})">Remove</button></td>`;
    tb.appendChild(tr);
  });
  calcTotals();
}
function removeItem(i){ items.splice(i,1); renderItems(); }
$('#addItem').addEventListener('click',()=>{
  const name=$('#itemName').value, qty=Number($('#qty').value||1), price=Number($('#price').value||0);
  if(!name||qty<=0) return; items.push({name,qty,price}); renderItems();
});

/* Totals */
function calcTotals(){
  const sub=items.reduce((s,it)=>s+it.qty*it.price,0);
  const vat=$('#vatOn').checked? sub*0.2 : 0;
  const tot=sub+vat;
  $('#subtotal').textContent=fmt(sub);
  $('#vat').textContent=fmt(vat);
  $('#total').textContent=fmt(tot);
}
$('#vatOn').addEventListener('change',calcTotals);

/* Signature pad */
const canvas=$('#sig'); const ctx=canvas.getContext('2d'); ctx.lineWidth=2; ctx.strokeStyle='#e9edf7';
let drawing=false,last=null;
function pos(e){const r=canvas.getBoundingClientRect(); const t=e.touches?e.touches[0]:e; return {x:t.clientX-r.left,y:t.clientY-r.top};}
function down(e){drawing=true; last=pos(e); e.preventDefault();}
function move(e){if(!drawing) return; const p=pos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; e.preventDefault();}
function up(){drawing=false;}
canvas.addEventListener('mousedown',down); canvas.addEventListener('mousemove',move); window.addEventListener('mouseup',up);
canvas.addEventListener('touchstart',down,{passive:false}); canvas.addEventListener('touchmove',move,{passive:false}); canvas.addEventListener('touchend',up);
$('#clearSig').addEventListener('click',()=>ctx.clearRect(0,0,canvas.width,canvas.height));

function getSignatureData(){ return canvas.toDataURL('image/png'); }
function loadSignature(data){ const img=new Image(); img.onload=()=>ctx.drawImage(img,0,0); img.src=data; }

/* Save contract (with signature) */
$('#saveContract').addEventListener('click',()=>{
  const id = crypto.randomUUID();
  const data = {
    id,
    contractNo: $('#contractNo').value || `MXC-${new Date().toISOString().slice(0,10)}-${Math.floor(Math.random()*9000+1000)}`,
    jobType:$('#jobType').value, installDate:$('#installDate').value,
    custName:$('#custName').value, custPhone:$('#custPhone').value, custEmail:$('#custEmail').value,
    addr1:$('#addr1').value, postcode:$('#postcode').value, apptDate:$('#apptDate').value,
    repName:$('#repName').value, bookingAgent:$('#bookingAgent').value, confirmer:$('#confirmer').value,
    notes:$('#notes').value,
    items,
    subtotal:Number($('#subtotal').textContent), vat:Number($('#vat').textContent), total:Number($('#total').textContent),
    signatureData:getSignatureData()
  };
  $('#contractNo').value = data.contractNo;
  const list = load('mxc_contracts'); list.push(data); save('mxc_contracts',list);
  alert('Contract saved.');
});

/* PDF (captures signature + all content) */
$('#downloadPDF').addEventListener('click', async ()=>{
  const { jsPDF } = window.jspdf;
  // temporarily ensure a dark background is captured
  const area=document.querySelector('main');
  const canvasShot = await html2canvas(area,{scale:2,backgroundColor:'#0c0f16'});
  const img=canvasShot.toDataURL('image/png');
  const pdf=new jsPDF('p','pt','a4');
  const pageW=pdf.internal.pageSize.getWidth(), pageH=pdf.internal.pageSize.getHeight();
  const ratio=Math.min(pageW/canvasShot.width,pageH/canvasShot.height);
  const w=canvasShot.width*ratio, h=canvasShot.height*ratio;
  pdf.addImage(img,'PNG',(pageW-w)/2,20,w,h);
  pdf.save( ($('#contractNo').value||'contract') + '.pdf');
});

/* init */
renderItems(); calcTotals();
</script>
</body>
</html>
