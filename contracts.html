<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Warm Up UK Contract</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; padding:10px; }
    h2 { margin-bottom:6px; }
    .box { background:#fff; border:1px solid #ccc; padding:10px; margin-bottom:10px; }
    input, select, textarea { width:100%; padding:5px; margin-bottom:6px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border:1px solid #ddd; padding:4px; font-size:13px; }
    th { background:#eee; }
    button { padding:6px 10px; margin-top:5px; }
    #sigCanvas { background:#fff; border:1px solid #aaa; width:100%; touch-action:none; }
    .row { display:flex; gap:6px; }
    .row > div { flex:1; }
    #waLinkBox, #pdfLinkBox { width:100%; font-size:12px; }
  </style>
  <!-- jsPDF CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<h2>Warm Up UK – Contract</h2>
<div class="box">
  <div class="row">
    <div>
      <label>Client name</label>
      <input id="clientName" />
    </div>
    <div>
      <label>Client phone (WhatsApp)</label>
      <input id="clientPhone" placeholder="07..." />
    </div>
  </div>
  <div class="row">
    <div>
      <label>Address</label>
      <input id="clientAddress" />
    </div>
    <div>
      <label>Postcode</label>
      <input id="clientPostcode" />
    </div>
  </div>
  <div class="row">
    <div>
      <label>Booking agent</label>
      <input id="bookingAgent" />
    </div>
    <div>
      <label>Confirmer</label>
      <input id="confirmer" />
    </div>
  </div>
  <div>
    <label>Install date</label>
    <input id="installDate" type="date" />
  </div>
</div>

<div class="box">
  <h3>Products / Works</h3>
  <table id="itemsTable">
    <thead>
      <tr>
        <th style="width:40%">Item</th>
        <th style="width:10%">Qty</th>
        <th style="width:15%">£/Unit</th>
        <th style="width:15%">Unit</th>
        <th style="width:15%">Line £</th>
        <th style="width:5%"></th>
      </tr>
    </thead>
    <tbody id="itemsBody">
      <!-- rows go here -->
    </tbody>
  </table>
  <button onclick="addRow()">+ Add row</button>
  <div style="margin-top:10px">
    <div class="row">
      <div>Subtotal:</div>
      <div><input id="subtotal" readonly /></div>
    </div>
    <div class="row">
      <div>Discount:</div>
      <div class="row" style="gap:3px;">
        <input id="discountVal" value="0" oninput="recalc()" />
        <select id="discountType" onchange="recalc()">
          <option value="amount">£</option>
          <option value="percent">%</option>
        </select>
      </div>
    </div>
    <div class="row">
      <div><label><input id="vatOn" type="checkbox" checked onchange="recalc()" /> VAT 20%</label></div>
      <div><input id="vatAmt" readonly /></div>
    </div>
    <div class="row">
      <div>Deposit:</div>
      <div><input id="deposit" value="0" oninput="recalc()" /></div>
    </div>
    <div class="row">
      <div><b>FINAL TOTAL:</b></div>
      <div><input id="finalTotal" readonly style="font-weight:bold;" /></div>
    </div>
  </div>
</div>

<div class="box">
  <h3>Notes</h3>
  <textarea id="notes" rows="4"></textarea>
</div>

<div class="box">
  <h3>Signature</h3>
  <canvas id="sigCanvas" width="300" height="140"></canvas>
  <button onclick="clearSig()">Clear</button>
  <input id="signedBy" placeholder="Signed name" />
  <p style="font-size:12px;color:#555;">Use finger/stylus on touch device.</p>
</div>

<div class="box">
  <h3>PDF & WhatsApp</h3>
  <button onclick="generatePDF()">Generate PDF</button>
  <p style="font-size:12px;color:#555;">This makes a PDF in the browser with the signature.</p>
  <input id="pdfLinkBox" placeholder="PDF link will appear here..." readonly />
  <button onclick="sendWA()">Send to WhatsApp (with PDF link)</button>
  <p style="font-size:12px;color:#555;">If it doesn’t auto-open, copy the link below and tap it:</p>
  <input id="waLinkBox" readonly />
  <p id="waError" style="color:red;display:none;">Add a phone number.</p>
</div>

<script>
  // ===== BASIC TABLE =====
  function addRow(item="Loft Insulation 270mm", qty=1, price=650, unit="job"){
    var tbody = document.getElementById("itemsBody");
    var tr = document.createElement("tr");

    var td1 = document.createElement("td");
    var sel = document.createElement("select");
    var products = [
      "Loft Insulation 270mm",
      "Loft Insulation 400mm",
      "Multifoil (TLX / YBS)",
      "Spray Foam Removal",
      "Loft Boarding",
      "Ventilation / Soffit Vents",
      "Waste Removal",
      "Other Item"
    ];
    for (var i=0;i<products.length;i++){
      var o = document.createElement("option");
      o.value = products[i];
      o.textContent = products[i];
      sel.appendChild(o);
    }
    sel.value = item;
    sel.setAttribute("onchange","recalc()");
    td1.appendChild(sel);
    tr.appendChild(td1);

    var td2 = document.createElement("td");
    var inQty = document.createElement("input");
    inQty.type = "number"; inQty.value = qty; inQty.min="0"; inQty.step="0.01";
    inQty.setAttribute("oninput","recalc()");
    td2.appendChild(inQty);
    tr.appendChild(td2);

    var td3 = document.createElement("td");
    var inPrice = document.createElement("input");
    inPrice.type="number"; inPrice.value = price; inPrice.min="0"; inPrice.step="0.01";
    inPrice.setAttribute("oninput","recalc()");
    td3.appendChild(inPrice);
    tr.appendChild(td3);

    var td4 = document.createElement("td");
    var unitSel = document.createElement("select");
    ["m²","lm","item","job"].forEach(function(u){
      var o = document.createElement("option");
      o.value = u; o.textContent = u;
      unitSel.appendChild(o);
    });
    unitSel.value = unit;
    unitSel.setAttribute("onchange","recalc()");
    td4.appendChild(unitSel);
    tr.appendChild(td4);

    var td5 = document.createElement("td");
    var lineTotal = document.createElement("input");
    lineTotal.readOnly = true;
    lineTotal.value = "0.00";
    td5.appendChild(lineTotal);
    tr.appendChild(td5);

    var td6 = document.createElement("td");
    var btn = document.createElement("button");
    btn.textContent = "X";
    btn.setAttribute("onclick","this.parentNode.parentNode.remove();recalc();");
    td6.appendChild(btn);
    tr.appendChild(td6);

    tbody.appendChild(tr);
    recalc();
  }

  // start with 2 rows
  addRow("Loft Insulation 270mm",1,650,"job");
  addRow("Ventilation / Soffit Vents",1,120,"item");

  function recalc(){
    var tbody = document.getElementById("itemsBody");
    var rows = tbody.getElementsByTagName("tr");
    var subtotal = 0;
    for (var i=0;i<rows.length;i++){
      var r = rows[i];
      var qty = parseFloat(r.cells[1].children[0].value) || 0;
      var price = parseFloat(r.cells[2].children[0].value) || 0;
      var line = qty * price;
      r.cells[4].children[0].value = line.toFixed(2);
      subtotal += line;
    }
    document.getElementById("subtotal").value = "£" + subtotal.toFixed(2);

    // discount
    var discountVal = parseFloat(document.getElementById("discountVal").value) || 0;
    var discountType = document.getElementById("discountType").value;
    var afterDisc = subtotal;
    if (discountVal > 0){
      if (discountType === "percent"){
        discountVal = subtotal * (discountVal / 100);
      }
      afterDisc = Math.max(0, subtotal - discountVal);
    }

    // vat
    var vat = 0;
    if (document.getElementById("vatOn").checked){
      vat = afterDisc * 0.2;
    }
    document.getElementById("vatAmt").value = "£" + vat.toFixed(2);

    // deposit
    var deposit = parseFloat(document.getElementById("deposit").value) || 0;
    var final = Math.max(0, afterDisc + vat - deposit);
    document.getElementById("finalTotal").value = "£" + final.toFixed(2);

    return {
      subtotal: subtotal,
      discount: discountVal,
      afterDisc: afterDisc,
      vat: vat,
      deposit: deposit,
      final: final
    };
  }

  // ===== SIGNATURE (simple) =====
  var canvas = document.getElementById("sigCanvas");
  var ctx = canvas.getContext("2d");
  ctx.lineWidth = 2;
  ctx.lineCap = "round";
  var drawing = false;

  function getPos(evt){
    var rect = canvas.getBoundingClientRect();
    var x, y;
    if (evt.touches && evt.touches.length > 0){
      x = evt.touches[0].clientX - rect.left;
      y = evt.touches[0].clientY - rect.top;
    } else {
      x = evt.clientX - rect.left;
      y = evt.clientY - rect.top;
    }
    return {x:x,y:y};
  }

  canvas.addEventListener("mousedown", function(e){
    drawing = true;
    var p = getPos(e);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
  });
  canvas.addEventListener("mousemove", function(e){
    if(!drawing) return;
    var p = getPos(e);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
  });
  canvas.addEventListener("mouseup", function(e){ drawing = false; });
  canvas.addEventListener("mouseleave", function(e){ drawing = false; });

  canvas.addEventListener("touchstart", function(e){
    e.preventDefault();
    drawing = true;
    var p = getPos(e);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
  }, {passive:false});
  canvas.addEventListener("touchmove", function(e){
    e.preventDefault();
    if(!drawing) return;
    var p = getPos(e);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
  }, {passive:false});
  canvas.addEventListener("touchend", function(e){
    e.preventDefault();
    drawing = false;
  }, {passive:false});

  function clearSig(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
  }

  // ===== PDF GENERATION =====
  // we'll store the latest PDF URL so we can send it in WhatsApp
  var latestPdfUrl = "";

  async function generatePDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // data
    var name = document.getElementById("clientName").value;
    var phone = document.getElementById("clientPhone").value;
    var addr = document.getElementById("clientAddress").value;
    var pc = document.getElementById("clientPostcode").value;
    var installDate = document.getElementById("installDate").value;
    var notes = document.getElementById("notes").value;
    var signedBy = document.getElementById("signedBy").value;
    var totals = recalc();

    doc.setFontSize(14);
    doc.text("Warm Up UK – Contract", 10, 15);
    doc.setFontSize(10);
    doc.text("Client: " + (name || "-"), 10, 22);
    doc.text("Phone: " + (phone || "-"), 10, 27);
    doc.text("Address: " + (addr || "-") + " " + (pc || ""), 10, 32);
    doc.text("Install date: " + (installDate || "TBC"), 10, 37);

    doc.text("Items:", 10, 44);
    var y = 50;
    var tbody = document.getElementById("itemsBody");
    var rows = tbody.getElementsByTagName("tr");
    for (var i=0;i<rows.length;i++){
      var r = rows[i];
      var item = r.cells[0].children[0].value;
      var qty = r.cells[1].children[0].value;
      var price = r.cells[2].children[0].value;
      var unit = r.cells[3].children[0].value;
      var line = r.cells[4].children[0].value;
      doc.text("• " + item + " (" + qty + " " + unit + " @ £" + Number(price||0).toFixed(2) + ") = £" + line, 10, y);
      y += 5;
      if (y > 260) { doc.addPage(); y = 20; }
    }

    y += 4;
    doc.text("Subtotal: £" + totals.subtotal.toFixed(2), 10, y); y+=5;
    doc.text("Discount: £" + totals.discount.toFixed(2), 10, y); y+=5;
    doc.text("VAT: £" + totals.vat.toFixed(2), 10, y); y+=5;
    doc.text("Deposit: £" + totals.deposit.toFixed(2), 10, y); y+=5;
    doc.text("TOTAL DUE: £" + totals.final.toFixed(2), 10, y); y+=8;

    doc.text("Notes:", 10, y); y+=5;
    doc.text(doc.splitTextToSize(notes || "-", 190), 10, y); y+=15;

    // Signature image from canvas
    var imgData = canvas.toDataURL("image/png");
    doc.text("Signature:", 10, y);
    doc.addImage(imgData, "PNG", 10, y+3, 60, 30);
    doc.text("Signed by: " + (signedBy || "Pending"), 10, y+38);

    // create blob & url
    const pdfBlob = doc.output("blob");
    const pdfUrl = URL.createObjectURL(pdfBlob);
    latestPdfUrl = pdfUrl;
    document.getElementById("pdfLinkBox").value = pdfUrl;

    // also open it so you can save/send
    window.open(pdfUrl, "_blank");
  }

  // ===== WHATSAPP =====
  function sendWA(){
    var phoneRaw = document.getElementById("clientPhone").value.trim();
    var err = document.getElementById("waError");
    if (!phoneRaw){
      err.style.display = "block";
      return;
    }
    err.style.display = "none";

    var totals = recalc();
    var name = document.getElementById("clientName").value;
    var addr = document.getElementById("clientAddress").value;
    var pc = document.getElementById("clientPostcode").value;
    var notes = document.getElementById("notes").value;
    var installDate = document.getElementById("installDate").value;
    var signedBy = document.getElementById("signedBy").value;

    // build items
    var tbody = document.getElementById("itemsBody");
    var rows = tbody.getElementsByTagName("tr");
    var itemLines = [];
    for (var i=0;i<rows.length;i++){
      var r = rows[i];
      var item = r.cells[0].children[0].value;
      var qty = r.cells[1].children[0].value;
      var price = r.cells[2].children[0].value;
      var unit = r.cells[3].children[0].value;
      var line = r.cells[4].children[0].value;
      itemLines.push("• " + item + " (" + qty + " " + unit + " @ £" + parseFloat(price||0).toFixed(2) + ") = £" + line);
    }

    var pdfPart = latestPdfUrl ? ("\nPDF (tap to open/save): " + latestPdfUrl + "\n") : "\n(PDF not generated yet – ask me to send it.)\n";

    var msg = 
"Warm Up UK Contract\n" +
"Client: " + name + "\n" +
"Address: " + addr + " " + pc + "\n\n" +
"Items:\n" + itemLines.join("\n") + "\n\n" +
"Subtotal: £" + totals.subtotal.toFixed(2) + "\n" +
"Discount: £" + totals.discount.toFixed(2) + "\n" +
"VAT: £" + totals.vat.toFixed(2) + "\n" +
"Deposit: £" + totals.deposit.toFixed(2) + "\n" +
"TOTAL DUE: £" + totals.final.toFixed(2) + "\n" +
"Install: " + (installDate || "TBC") + "\n" +
"Notes: " + (notes || "-") + "\n" +
"Signed by: " + (signedBy || "Pending") + "\n" +
pdfPart;

    // normalise phone
    var phone = phoneRaw.replace(/\s|\+/g,"");
    if (phone.startsWith("0")) {
      phone = "44" + phone.slice(1);
    }

    var link = "https://wa.me/" + phone + "?text=" + encodeURIComponent(msg);
    document.getElementById("waLinkBox").value = link;

    try {
      window.open(link, "_blank");
    } catch(e) {}
  }
</script>

</body>
</html>
