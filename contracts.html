<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Warm Up UK Homes — Contract Builder</title>
<link rel="icon" href="assets/warmupuk-logo.png.PNG">
<style>
:root{
  --bg:#0b0b0b; --panel:#121212; --ink:#f3f3f3; --muted:#bdbdbd;
  --gold:#d4af37; --line:#2a2a2a; --ok:#00ff7b; --orange:#ff8c00;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);
  font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.wrap{max-width:980px;margin:18px auto;padding:0 14px}

/* Animated banner */
.banner{
  position:sticky; top:0; z-index:10; margin:0 0 16px 0; border-radius:18px; overflow:hidden;
  background: radial-gradient(120% 100% at 10% -20%, #3a2e07 0%, #1b1a15 55%, #121213 100%);
  border:1px solid #3b2f12; box-shadow:0 10px 28px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.04);
  animation: slideDown .7s ease-out both;
}
@keyframes slideDown{ from{ transform:translateY(-14px); opacity:0 } to{ transform:none; opacity:1 } }
.banner .row{display:flex;align-items:center;justify-content:space-between;gap:14px;padding:14px 16px}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:56px;height:56px;border-radius:12px;object-fit:contain;background:#000;border:1px solid #333;
  animation: shimmer 2.4s linear infinite}
@keyframes shimmer{
  0%{box-shadow:inset 0 0 0 1px rgba(212,175,55,.15)}
  50%{box-shadow:0 0 16px rgba(212,175,55,.35), inset 0 0 0 1px rgba(212,175,55,.25)}
  100%{box-shadow:inset 0 0 0 1px rgba(212,175,55,.15)}
}
h1{margin:0;font-size:26px;letter-spacing:.6px}
.btnbar{display:flex;gap:10px;flex-wrap:wrap}
button{appearance:none;border:0;padding:12px 16px;border-radius:12px;font-weight:800;cursor:pointer}
.btn{background:var(--gold);color:#201a00}
.ghost{background:#1a1a1a;color:#f1f1f1;border:1px solid #343434}

.card{background:linear-gradient(180deg,#1a1a1a,#111);border:1px solid #2a2a2a;border-radius:16px;padding:16px 18px;box-shadow:0 10px 30px rgba(0,0,0,.4);margin-bottom:16px}
.section{border:1px dashed #3a3a3a;border-radius:14px;padding:14px 12px;background:var(--panel);margin-top:16px}
.title{font-size:18px;color:var(--gold);font-weight:800;margin:4px 4px 10px}
label{display:block;font-size:14px;color:var(--muted);margin:10px 6px 6px}
input,textarea,select{
  width:100%;background:#0f0f0f;color:#f3f3f3;border:1px solid #2b2b2b;
  border-radius:12px;padding:14px;font-size:16px;outline:none}
input:focus,textarea:focus,select:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(212,175,55,.15)}
.row{display:grid;gap:12px}
@media(min-width:680px){ .c2{grid-template-columns:1fr 1fr} .c3{grid-template-columns:1fr 1fr 1fr} .c4{grid-template-columns:2fr 100px 140px 140px}}

/* ORANGE outline fields */
.orange-outline{
  border:2px solid var(--orange)!important;
  box-shadow:0 0 0 3px rgba(255,140,0,.15);
}

/* Toggles (button style for iPhone reliability) */
.toggle{display:flex;align-items:center;justify-content:space-between;background:#0f0f0f;border:1px solid #2b2b2b;border-radius:12px;padding:10px 12px}
.badge{padding:.35rem .7rem;border:1px solid #3b3b3b;border-radius:999px;background:#101014;color:#cfd0d4;font-weight:800}
.lamp{width:16px;height:16px;border-radius:50%;background:#222;border:1px solid #444;margin-left:10px;box-shadow:none;transition:.15s}
.lamp.on{background:var(--ok);box-shadow:0 0 10px var(--ok)}

/* Products */
.tblHead{display:grid;grid-template-columns:2fr 100px 140px 140px 44px;gap:10px;padding:8px 6px;color:var(--muted)}
.lineRow{display:grid;grid-template-columns:2fr 100px 140px 140px 44px;gap:10px;margin-bottom:10px}
.desc{min-height:56px}
.xbtn{border:1px solid #3b3b3b;background:#111;border-radius:10px;width:44px;color:#fff}
.addBtn{margin-top:6px}

/* Neon flash for discount fields */
.flash{
  border-color:var(--ok)!important;
  box-shadow:0 0 0 2px rgba(0,255,123,.25),0 0 18px rgba(0,255,123,.65);
  animation:blink .9s infinite alternate}
@keyframes blink{from{background:#0f0f0f}to{background:rgba(0,255,123,.08)}}

/* Totals */
.sum{display:flex;justify-content:space-between;align-items:center;border:2px solid var(--orange);border-radius:14px;padding:14px 16px;font-weight:800;margin-top:12px}
.sumbig{font-size:22px}

/* Signature: black box + orange pen */
#sig{background:#000;border:2px dashed var(--orange);border-radius:12px;touch-action:none;width:100%;height:240px}
.smallBtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.footnote{color:#888;font-size:12px;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">

  <!-- Animated logo banner -->
  <div class="banner">
    <div class="row">
      <div class="brand">
        <img class="logo" src="assets/warmupuk-logo.png.PNG" alt="Logo" onerror="this.style.display='none'">
        <div>
          <h1>WARM UP UK HOMES</h1>
        </div>
      </div>
      <div class="btnbar">
        <button class="btn"   id="btnPDF">Save PDF</button>
        <button class="ghost" id="btnShareWa">WhatsApp</button>
        <button class="ghost" id="btnSavePhone">Save quote to phone</button>
      </div>
    </div>
  </div>

  <!-- Meta -->
  <div class="card">
    <div class="row c2">
      <div>
        <label>Contract Number</label>
        <input id="contractNo" readonly placeholder="WUUK-YYYYMMDD-XXXX">
      </div>
      <div>
        <label>Date</label>
        <input id="date" type="date">
      </div>
    </div>

    <div class="row c2" style="margin-top:8px">
      <div>
        <label>Customer Name</label>
        <input id="client" class="orange-outline" placeholder="Full name">
      </div>
      <div>
        <label>Phone Number (WhatsApp)</label>
        <input id="phone" class="orange-outline" inputmode="tel" placeholder="+44… or 07…">
      </div>
    </div>

    <label style="margin-top:10px">Address</label>
    <input id="address" class="orange-outline" placeholder="Address, Postcode">
  </div>

  <!-- Products -->
  <div class="section">
    <div class="title">PRODUCTS &amp; PRICING</div>

    <!-- Product dropdown + add -->
    <div class="row c3">
      <div>
        <label>Quick Product</label>
        <select id="productSelect">
          <option value="" selected>Select a product…</option>
          <option value="Spray Foam Removal">Spray Foam Removal</option>
          <option value="Ceiling Level Insulation">Ceiling Level Insulation</option>
          <option value="Multifoil">Multifoil</option>
        </select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="ghost" id="addProduct">Add selected product</button>
      </div>
      <div>
        <label>Total Price (£)</label>
        <input id="manualTotal" type="number" min="0" step="0.01" value="0" placeholder="Optional quick total">
      </div>
    </div>

    <div class="tblHead" style="margin-top:10px">
      <div>Description</div><div>Qty</div><div>Unit £</div><div>Line £</div><div></div>
    </div>
    <div id="lines"></div>
    <button id="addLine" class="ghost addBtn">+ Add line</button>

    <div class="row c3" style="margin-top:14px">
      <div>
        <label class="muted">VAT (20%)</label>
        <div class="toggle">
          <span>Apply VAT</span>
          <span class="badge" id="vatState">OFF</span>
          <button id="vatBtn" type="button" class="badge" aria-pressed="false">Toggle</button>
          <span class="lamp" id="vatLamp" aria-hidden="true"></span>
        </div>
      </div>

      <div>
        <label class="muted">Discount</label>
        <div class="toggle">
          <span>Enable Discount</span>
          <span class="badge" id="discState">OFF</span>
          <button id="discBtn" type="button" class="badge" aria-pressed="false">Toggle</button>
          <span class="lamp" id="discLamp" aria-hidden="true"></span>
        </div>
      </div>

      <div>
        <label>Deposit (£)</label>
        <input id="deposit" type="number" min="0" step="0.01" value="0">
        <div class="smallBtns">
          <button class="ghost" id="dep20" type="button">20%</button>
          <button class="ghost" id="dep25" type="button">25%</button>
          <button class="ghost" id="depClear" type="button">Clear</button>
        </div>
      </div>
    </div>

    <div class="row c3" style="margin-top:12px">
      <div>
        <label>Discount Before (£)</label>
        <input id="discBefore" type="number" min="0" step="0.01" value="0" disabled>
      </div>
      <div>
        <label>Discount After (£)</label>
        <input id="discAfter" type="number" min="0" step="0.01" value="0" disabled>
      </div>
      <div>
        <label>Subtotal</label>
        <input id="subtotal" readonly>
      </div>
    </div>

    <div class="row c2" style="margin-top:12px">
      <div class="sum" style="border-color:#6b6b6b">
        <div>VAT (20%): <span id="vatLabel">Off</span></div>
        <div>VAT £ <span id="vatOut">0.00</span></div>
      </div>
      <div class="sum" style="border-color:#6b6b6b">
        <div>Grand Total</div>
        <div class="sumbig">£<span id="grandOut">0.00</span></div>
      </div>
    </div>

    <div class="sum">
      <div>Final to Pay Today</div>
      <div class="sumbig">£<span id="finalOut">0.00</span></div>
    </div>
  </div>

  <!-- Notes + Signature -->
  <div class="section">
    <label>Notes / Special Instructions</label>
    <textarea id="notes" rows="4" placeholder="Enter job notes or installation details"></textarea>

    <div class="title" style="margin-top:8px">Signature</div>
    <canvas id="sig"></canvas>
    <div class="smallBtns">
      <button class="ghost" id="sigClear" type="button">Clear signature</button>
      <button class="ghost" id="sigSave"  type="button">Save signature PNG</button>
    </div>

    <div class="footnote">Autosaves to this device. Use “Save quote to phone” for a file copy.</div>
  </div>
</div>

<!-- PDF libs -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
(function(){
  const $ = s=>document.querySelector(s);

  // Contract/date
  function genContract(){
    const d=new Date(), y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'),
          dd=String(d.getDate()).padStart(2,'0'), r=Math.floor(Math.random()*9000+1000);
    return \`WUUK-\${y}\${m}\${dd}-\${r}\`;
  }
  $('#contractNo').value = genContract();
  $('#date').valueAsDate = new Date();

  // Lines
  const linesEl = $('#lines');
  function makeLine(desc='', qty=1, unit=0){
    const row=document.createElement('div'); row.className='lineRow';
    row.innerHTML=\`
      <textarea class="desc" placeholder="e.g., Loft insulation — supply & fit">\${desc}</textarea>
      <input class="qty" type="number" min="0" step="1" value="\${qty}">
      <input class="unit" type="number" min="0" step="0.01" value="\${unit}">
      <input class="line" type="text" value="0.00" readonly>
      <button class="xbtn" title="Remove" type="button">×</button>\`;
    row.querySelector('.xbtn').onclick=()=>{ row.remove(); recalc(); save(); };
    row.addEventListener('input', ()=>{ recalc(); save(); });
    linesEl.appendChild(row);
    recalc();
  }
  $('#addLine').addEventListener('click', ()=>makeLine());
  makeLine(); // seed

  // Product dropdown add
  $('#addProduct').addEventListener('click', ()=>{
    const v = $('#productSelect').value;
    if(!v) return alert('Select a product first.');
    makeLine(v, 1, 0);
  });

  // Toggles as aria-pressed buttons
  const vatBtn = $('#vatBtn'), discBtn=$('#discBtn'), vatLamp=$('#vatLamp'), discLamp=$('#discLamp');
  function setPressed(btn, on){
    btn.setAttribute('aria-pressed', on ? 'true' : 'false');
    if(btn===vatBtn){ $('#vatState').textContent = on?'ON':'OFF'; vatLamp.classList.toggle('on', on); }
    if(btn===discBtn){
      $('#discState').textContent = on?'ON':'OFF';
      discLamp.classList.toggle('on', on);
      $('#discBefore').disabled = !on; $('#discAfter').disabled = !on;
      $('#discBefore').classList.toggle('flash', on); $('#discAfter').classList.toggle('flash', on);
    }
    recalc(); save();
  }
  vatBtn.addEventListener('click', ()=> setPressed(vatBtn, vatBtn.getAttribute('aria-pressed')!=='true'));
  discBtn.addEventListener('click',()=> setPressed(discBtn,discBtn.getAttribute('aria-pressed')!=='true'));

  // Calc helpers
  const money=n=>(Math.round((+n+Number.EPSILON)*100)/100).toFixed(2);
  function recalc(){
    let subtotal=0;
    linesEl.querySelectorAll('.lineRow').forEach(row=>{
      const q=+row.querySelector('.qty').value||0;
      const u=+row.querySelector('.unit').value||0;
      const amt=q*u;
      row.querySelector('.line').value=money(amt);
      subtotal += amt;
    });

    // allow an optional manual total to override subtotal if > 0
    const manual = +($('#manualTotal').value || 0);
    if (manual > 0) subtotal = manual;

    $('#subtotal').value = '£ '+money(subtotal);

    const vatOn  = (vatBtn.getAttribute('aria-pressed')==='true');
    const discOn = (discBtn.getAttribute('aria-pressed')==='true');

    const db = discOn ? (+$('#discBefore').value||0) : 0;
    const da = discOn ? (+$('#discAfter').value||0)  : 0;

    let net = subtotal - db + da;
    let vat = vatOn ? net * 0.20 : 0;
    let grand = net + vat;

    $('#vatLabel').textContent = vatOn ? 'On' : 'Off';
    $('#vatOut').textContent   = money(vat);
    $('#grandOut').textContent = money(grand);

    const dep = +$('#deposit').value || 0;
    let final = grand - dep; if(final<0) final=0;
    $('#finalOut').textContent = money(final);
  }
  document.addEventListener('input', e=>{
    if(['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) { recalc(); save(); }
  });

  // Deposit quick buttons
  function setDeposit(pct){
    recalc();
    const grand = +($('#grandOut').textContent||'0');
    $('#deposit').value = money(grand * pct);
    recalc(); save();
  }
  $('#dep20').onclick=()=>setDeposit(0.20);
  $('#dep25').onclick=()=>setDeposit(0.25);
  $('#depClear').onclick=()=>{ $('#deposit').value='0'; recalc(); save(); };

  // Store mode (autosave)
  function pack(){
    return {
      contractNo: $('#contractNo').value, date: $('#date').value,
      client: $('#client').value, phone: $('#phone').value, address: $('#address').value,
      deposit: $('#deposit').value, manualTotal: $('#manualTotal').value,
      vat: vatBtn.getAttribute('aria-pressed')==='true',
      disc: discBtn.getAttribute('aria-pressed')==='true',
      discBefore: $('#discBefore').value, discAfter: $('#discAfter').value,
      notes: $('#notes').value,
      lines: [...document.querySelectorAll('.lineRow')].map(r=>({
        d:r.querySelector('.desc').value, q:r.querySelector('.qty').value, u:r.querySelector('.unit').value
      }))
    };
  }
  function save(){ localStorage.setItem('wuuk_contract_v4', JSON.stringify(pack())); }
  (function load(){
    try{
      const s=JSON.parse(localStorage.getItem('wuuk_contract_v4')||'{}');
      if(!s) return;
      $('#contractNo').value = s.contractNo || genContract();
      $('#date').value = s.date || new Date().toISOString().slice(0,10);
      ['client','phone','address','deposit','discBefore','discAfter','notes','manualTotal'].forEach(id=>{ if(s[id]!=null) $('#'+id).value=s[id]; });
      linesEl.innerHTML='';
      (s.lines && s.lines.length ? s.lines : [{d:'',q:1,u:0}]).forEach(l=> makeLine(l.d,l.q,l.u));
      setPressed(vatBtn, !!s.vat);
      setPressed(discBtn,!!s.disc);
      recalc();
    }catch(e){}
  })();

  // Signature (black box + orange pen, pointer events)
  const sig = $('#sig'); const ctx = sig.getContext('2d');
  function fitCanvas(){
    const ratio = window.devicePixelRatio||1;
    sig.width = Math.floor(sig.clientWidth * ratio);
    sig.height= Math.floor(240 * ratio);
    ctx.setTransform(ratio,0,0,ratio,0,0); // ensure no compound scaling
    ctx.lineWidth=2.2; ctx.lineCap='round'; ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--orange').trim() || '#ff8c00';
  }
  fitCanvas(); addEventListener('resize', fitCanvas);
  let drawing=false, last=null;
  const getXY = (e)=>{
    const r=sig.getBoundingClientRect();
    const x=(e.clientX ?? (e.touches&&e.touches[0].clientX)) - r.left;
    const y=(e.clientY ?? (e.touches&&e.touches[0].clientY)) - r.top;
    return {x,y};
  };
  sig.addEventListener('pointerdown', e=>{ sig.setPointerCapture(e.pointerId); drawing=true; last=getXY(e); });
  sig.addEventListener('pointermove', e=>{
    if(!drawing) return;
    const p=getXY(e);
    ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p;
  });
  sig.addEventListener('pointerup',   ()=> drawing=false);
  sig.addEventListener('pointercancel',()=> drawing=false);
  $('#sigClear').onclick=()=>{ ctx.clearRect(0,0,sig.width,sig.height); fitCanvas(); };
  $('#sigSave').onclick=()=>{
    const a=document.createElement('a');
    a.href=sig.toDataURL('image/png'); a.download=($('#contractNo').value||'signature')+'_signature.png';
    document.body.appendChild(a); a.click(); setTimeout(()=>a.remove(),200);
  };

  // WhatsApp
  $('#btnShareWa').onclick=()=>{
    const msg=
`WARM UP UK HOMES
Contract: ${$('#contractNo').value}
Client: ${$('#client').value||'-'}
Address: ${$('#address').value||'-'}
Final Today: £${$('#finalOut').textContent}`;
    location.href='https://wa.me/?text='+encodeURIComponent(msg);
  };

  // Save quote to phone (txt)
  $('#btnSavePhone').onclick=()=>{
    const p = pack();
    const linesText = p.lines.map((l,i)=>\`\${i+1}. \${l.d||'-'} — Qty \${l.q||0} × £\${(+l.u||0).toFixed(2)} = £\${((+l.q||0)*(+l.u||0)).toFixed(2)}\`).join('\\n');
    const text=[
      'Warm Up UK Homes — Quote',
      '--------------------------------',
      'Contract: '+p.contractNo,
      'Date: '+p.date,
      'Client: '+p.client,
      'Phone: '+p.phone,
      'Address: '+p.address,
      '',
      'Products & Pricing:',
      linesText || '(none)',
      '',
      'Discount Before: £'+(+p.discBefore||0).toFixed(2),
      'Discount After: £'+(+p.discAfter||0).toFixed(2),
      'VAT: '+(p.vat?'On (20%)':'Off'),
      'Deposit: £'+(+p.deposit||0).toFixed(2),
      'Grand Total: £'+($('#grandOut').textContent),
      'Final Today: £'+($('#finalOut').textContent),
      '',
      'Notes:',
      p.notes||''
    ].join('\\n');
    const blob=new Blob([text],{type:'text/plain'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download=p.contractNo.replace(/\s+/g,'_')+'_quote.txt';
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },1200);
    alert('Saved! A text copy was downloaded and the quote is stored on this device.');
  };

  // Real PDF (html2canvas + jsPDF)
  $('#btnPDF').onclick=async()=>{
    const { jsPDF } = window.jspdf;
    const capture = document.querySelector('.wrap');
    const canvas = await html2canvas(capture, {scale:2, background:'#ffffff', useCORS:true});
    const imgData = canvas.toDataURL('image/jpeg', 0.95);

    const pdf = new jsPDF('p','pt','a4');
    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();
    const imgW = pageW;
    const imgH = canvas.height * (imgW / canvas.width);

    let y = 0;
    pdf.addImage(imgData, 'JPEG', 0, y, imgW, imgH);
    let heightLeft = imgH - pageH;

    while (heightLeft > 0) {
      y = heightLeft - imgH;
      pdf.addPage();
      pdf.addImage(imgData, 'JPEG', 0, y, imgW, imgH);
      heightLeft -= pageH;
    }
    pdf.save(`${$('#contractNo').value}.pdf`);
  };

  // initial calc after everything is wired
  recalc();

})();
</script>
</body>
</html>
