<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Warm Up UK Homes — Contract Builder</title>
<style>
  :root{
    --bg:#0f0f0f; --panel:#161616; --card:#1b1b1b;
    --text:#f7f7f7; --muted:#b8b8b8; --gold:#d8b24a;
    --orange:#ff8a00; --orange-20:#ff8a0026; --neon:#00ff88;
    --line:#2a2a2a;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto}
  *{box-sizing:border-box}
  .wrap{max-width:980px;margin:20px auto;padding:0 14px}
  .card{background:linear-gradient(180deg,#1e1a10,#121212);border:1px solid #2a2416;border-radius:18px;padding:16px 16px}
  .brand{display:flex;align-items:center;gap:14px}
  .logo{width:48px;height:48px;border-radius:12px;background:#000 url('assets/wuuk.webp') center/cover no-repeat;animation:float 5s ease-in-out infinite alternate}
  @keyframes float{from{transform:translateY(-2px)}to{transform:translateY(2px)}}
  h1{margin:2px 0 4px;font-size:28px;letter-spacing:.02em}
  .toolbar{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
  .btn{border-radius:14px;padding:12px 18px;border:1px solid #2c2c2c;background:#111;color:#e9e9e9}
  .btn.primary{background:var(--gold);color:#000;border-color:#4b3a12;font-weight:700}
  .btn.ghost{background:#171717}
  section{background:var(--panel);border:1px dashed #303030;border-radius:18px;margin:18px 0;padding:16px}
  h2{margin:0 0 12px;font-size:22px;color:var(--gold);letter-spacing:.04em}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  .row{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:640px){
    .row.two{grid-template-columns:1fr 1fr}
    .row.three{grid-template-columns:1fr 1fr 1fr}
    .row.four{grid-template-columns:2fr 1fr 1fr 1fr}
  }
  label{font-size:14px;color:var(--muted)}
  input,select,textarea{
    width:100%;padding:14px 14px;border-radius:14px;background:#101010;color:#fff;
    border:2px solid var(--orange);outline:none
  }
  input[type="number"]{-moz-appearance:textfield}
  input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0;}
  .tableHead{display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:10px;color:#bdbdbd;margin:8px 0}
  .line{display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:10px;margin:8px 0}
  .add{margin:8px 0}
  .switch{
    --w:56px; --h:34px; position:relative; display:inline-flex; align-items:center; gap:12px; font-weight:600
  }
  .switch input{appearance:none;width:var(--w);height:var(--h);border-radius:999px;background:#222;border:2px solid #333;position:relative;outline:none;cursor:pointer;box-shadow:0 0 0 0 rgba(0,255,136,0);transition:.2s}
  .switch input:checked{background:#062; border-color:#0b3; box-shadow:0 0 18px 6px rgba(0,255,136,.22)}
  .switch input:before{
    content:""; position:absolute;left:3px;top:3px;width:calc(var(--h) - 6px);height:calc(var(--h) - 6px);
    background:#eee;border-radius:50%;transition:.2s
  }
  .switch input:checked:before{transform:translateX(calc(var(--w) - var(--h))); background:var(--neon)}
  .totals{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:6px}
  .tile{background:#111;border:1px solid #2a2a2a;border-radius:16px;padding:12px 14px}
  .tile.big{grid-column:span 2}
  .money{font-size:24px;font-weight:800}
  .glow{box-shadow:0 0 24px 6px rgba(0,255,136,.25), inset 0 0 0 2px rgba(0,255,136,.35)}
  canvas{background:#000;border-radius:18px;border:3px dashed #ff9a20;touch-action:none}
  .sticky-wa{
    position:fixed;left:0;right:0;bottom:0;background:linear-gradient(90deg,#06d755,#128c7e);
    padding:10px 14px;display:flex;justify-content:center;z-index:999;border-top:1px solid #085e40
  }
  .sticky-wa .btn{background:#fff;color:#075e54;border:none;font-weight:800}
  .muted{color:#9c9c9c;font-size:12px;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">

  <!-- HERO / BRAND -->
  <div class="card">
    <div class="brand">
      <div class="logo" aria-label="logo"></div>
      <div>
        <h1>WARM UP UK HOMES</h1>
        <div class="muted">Contract Builder</div>
      </div>
    </div>
    <div class="toolbar">
      <button class="btn primary" id="btnPdf">Save PDF</button>
      <button class="btn ghost" id="btnWaTop">WhatsApp</button>
      <button class="btn ghost" id="btnSavePhone">Save quote to phone</button>
    </div>
  </div>

  <!-- CLIENT -->
  <section>
    <h2>CLIENT &amp; JOB DETAILS</h2>
    <div class="grid">
      <div>
        <label>Contract Number</label>
        <input id="contractNo" placeholder="WUUK-YYYYMMDD-XXXX" />
      </div>
      <div>
        <label>Date</label>
        <input id="date" />
      </div>
      <div>
        <label>Client name</label>
        <input id="client" placeholder="Full name" />
      </div>
      <div>
        <label>Contact number (WhatsApp)</label>
        <input id="phone" inputmode="tel" placeholder="+44... or 07..." />
      </div>
      <div>
        <label>Property address</label>
        <input id="address" placeholder="Address, Postcode" />
      </div>
    </div>
  </section>

  <!-- PRODUCTS -->
  <section id="products">
    <h2>PRODUCTS &amp; PRICING</h2>

    <div class="tableHead">
      <div>Product</div><div>Size (m)</div><div>Unit £/m</div><div>Line £</div>
    </div>

    <div id="lines"></div>

    <div class="add">
      <button class="btn" id="addLine">+ Add line</button>
    </div>

    <div class="row two">
      <label class="switch">VAT (20%)
        <input type="checkbox" id="vatToggle" checked>
      </label>
      <label class="switch">Enable Discount
        <input type="checkbox" id="discToggle">
      </label>
    </div>

    <div id="discBox" style="display:none;margin-top:12px" class="row two">
      <div>
        <label>Discount Before (£)</label>
        <input id="discBefore" type="number" inputmode="decimal" value="0">
      </div>
      <div>
        <label>Discount After (£)</label>
        <input id="discAfter" type="number" inputmode="decimal" value="0">
      </div>
    </div>

    <div class="totals">
      <div class="tile">
        <div>Subtotal</div>
        <div class="money" id="subtotal">£0.00</div>
      </div>
      <div class="tile">
        <div>VAT</div>
        <div class="money" id="vat">£0.00</div>
      </div>
      <div>
        <label>Deposit (paid / due now)</label>
        <input id="deposit" type="number" inputmode="decimal" value="0">
      </div>
      <div class="tile big" id="finalTile">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Final to Pay Today</div>
          <div class="money" id="final">£0.00</div>
        </div>
      </div>
    </div>
  </section>

  <!-- SIGNATURE -->
  <section>
    <h2>Signature</h2>
    <canvas id="pad" width="900" height="340"></canvas>
    <div style="margin-top:10px;display:flex;gap:10px;align-items:center">
      <button class="btn" id="clearSig">Clear</button>
      <div class="muted">Sign inside the black box with your finger (orange ink).</div>
    </div>
  </section>
</div>

<!-- Bottom sticky WhatsApp -->
<div class="sticky-wa">
  <button class="btn" id="btnWaBottom">Send to WhatsApp</button>
</div>

<script>
/* ---------- helpers ---------- */
const £ = (n)=> new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP'}).format(n||0);
const el = (s)=> document.querySelector(s);
const els = (s)=> Array.from(document.querySelectorAll(s));

/* ---------- state & init ---------- */
const PRODUCTS = [
  {text:'Spray Foam Removal', value:'spray', unit:80},
  {text:'Ceiling Level Insulation', value:'ceiling', unit:20},
  {text:'Multifoil', value:'multifoil', unit:30},
  {text:'Other (custom)', value:'other', unit:0}
];

function newLineRow(preset={product:'spray', size:0, unit:80}){
  const row = document.createElement('div');
  row.className = 'line';
  row.innerHTML = `
    <select class="p">
      ${PRODUCTS.map(p=>`<option value="${p.value}">${p.text}</option>`).join('')}
    </select>
    <input class="s" type="number" inputmode="decimal" value="${preset.size}">
    <input class="u" type="number" inputmode="decimal" value="${preset.unit}">
    <input class="l" type="text" value="£0.00" readonly>
  `;
  const pSel = row.querySelector('.p');
  pSel.value = preset.product;
  pSel.addEventListener('change', e=>{
    const found = PRODUCTS.find(x=>x.value===pSel.value);
    if(found && found.unit){ row.querySelector('.u').value = found.unit; }
    recalc();
  });
  row.addEventListener('input', recalc);
  el('#lines').appendChild(row);
}

function generateContractNo(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const da = String(d.getDate()).padStart(2,'0');
  const r = Math.floor(1000+Math.random()*9000);
  el('#contractNo').value = `WUUK-${y}${m}${da}-${r}`;
  el('#date').value = d.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
}

/* ---------- calc logic ---------- */
function recalc(){
  let subtotal = 0;
  els('#lines .line').forEach(line=>{
    const size = parseFloat(line.querySelector('.s').value||0);
    const unit = parseFloat(line.querySelector('.u').value||0);
    const lineTotal = size * unit;
    subtotal += lineTotal;
    line.querySelector('.l').value = £(lineTotal);
  });

  const vatOn = el('#vatToggle').checked;
  let vat = vatOn ? subtotal * 0.20 : 0;

  // discounts
  const discOn = el('#discToggle').checked;
  const before = parseFloat(el('#discBefore').value||0);
  const after  = parseFloat(el('#discAfter').value||0);

  // meaning:
  //  - "before" reduces the base before VAT
  //  - VAT recalculated on discounted base
  //  - "after" reduces the grand total
  let base = Math.max(subtotal - (discOn ? before : 0), 0);
  vat = vatOn ? base * 0.20 : 0;

  let grand = base + vat;
  if(discOn) grand = Math.max(grand - after, 0);

  const dep = parseFloat(el('#deposit').value||0);
  const final = Math.max(grand - dep, 0);

  el('#subtotal').textContent = £(base);
  el('#vat').textContent = £(vat);
  el('#final').textContent = £(final);

  // glow state when discount on
  el('#finalTile').classList.toggle('glow', discOn);
}

/* ---------- signature pad (touch + mouse) ---------- */
(function(){
  const c = el('#pad'); const ctx = c.getContext('2d');
  // crisp canvas on mobile
  function fitCanvas(){
    const ratio = window.devicePixelRatio || 1;
    const w = c.clientWidth, h = c.clientHeight;
    c.width = w * ratio; c.height = h * ratio;
    ctx.scale(ratio, ratio);
    ctx.lineWidth = 3; ctx.strokeStyle = '#ff8a00'; ctx.lineCap='round';
  }
  fitCanvas(); window.addEventListener('resize', fitCanvas);

  let drawing=false, last=null;
  const pos = (e)=>{
    if(e.touches?.length){
      const r = c.getBoundingClientRect();
      return {x:e.touches[0].clientX - r.left, y:e.touches[0].clientY - r.top};
    }else{
      const r = c.getBoundingClientRect();
      return {x:e.clientX - r.left, y:e.clientY - r.top};
    }
  };
  const start = (e)=>{ e.preventDefault(); drawing=true; last = pos(e); };
  const move  = (e)=>{
    if(!drawing) return;
    const p = pos(e);
    ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke();
    last = p;
  };
  const end   = ()=> drawing=false;

  ['mousedown','touchstart'].forEach(ev=>c.addEventListener(ev,start,{passive:false}));
  ['mousemove','touchmove'].forEach(ev=>c.addEventListener(ev,move,{passive:false}));
  ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev=>c.addEventListener(ev,end));
  el('#clearSig').addEventListener('click',()=>{ ctx.clearRect(0,0,c.width,c.height); fitCanvas(); });
})();

/* ---------- actions ---------- */
function saveToPhone(){
  const data = {
    contractNo: el('#contractNo').value, date: el('#date').value,
    client: el('#client').value, phone: el('#phone').value, address: el('#address').value,
    vatOn: el('#vatToggle').checked, discOn: el('#discToggle').checked,
    discBefore: el('#discBefore').value, discAfter: el('#discAfter').value,
    deposit: el('#deposit').value,
    lines: els('#lines .line').map(l=>({
      product:l.querySelector('.p').value,
      size:l.querySelector('.s').value, unit:l.querySelector('.u').value
    }))
  };
  localStorage.setItem('wuuk-contract', JSON.stringify(data));
  alert('Saved to your phone (local storage).');
}
function loadFromPhone(){
  const raw = localStorage.getItem('wuuk-contract');
  if(!raw) return;
  try{
    const d = JSON.parse(raw);
    el('#contractNo').value = d.contractNo||'';
    el('#date').value       = d.date||'';
    el('#client').value     = d.client||'';
    el('#phone').value      = d.phone||'';
    el('#address').value    = d.address||'';
    el('#vatToggle').checked  = !!d.vatOn;
    el('#discToggle').checked = !!d.discOn;
    el('#discBefore').value = d.discBefore||0;
    el('#discAfter').value  = d.discAfter||0;
    el('#deposit').value    = d.deposit||0;
    el('#lines').innerHTML = '';
    (d.lines||[]).forEach(l=> newLineRow({product:l.product,size:l.size,unit:l.unit}));
    recalc();
  }catch{}
}

function shareWhatsApp(){
  // Compose a compact message
  let msg = `WARM UP UK HOMES\nContract: ${el('#contractNo').value}\nClient: ${el('#client').value}\nAddress: ${el('#address').value}\n`;
  els('#lines .line').forEach((l,i)=>{
    const p = l.querySelector('.p'); const s=l.querySelector('.s').value; const u=l.querySelector('.u').value;
    const name = PRODUCTS.find(x=>x.value===p.value)?.text || 'Item';
    msg += `• ${name}: ${s}m @ £${u}/m\n`;
  });
  msg += `Subtotal: ${el('#subtotal').textContent}\nVAT: ${el('#vat').textContent}\nDeposit: £${(el('#deposit').value||0)}\nFinal Today: ${el('#final').textContent}`;
  const phone = el('#phone').value.replace(/\D/g,''); // optional
  const url = `https://api.whatsapp.com/send?${phone?`phone=${phone}&`:''}text=${encodeURIComponent(msg)}`;
  window.open(url, '_blank');
}

/* ---------- wire events ---------- */
el('#addLine').addEventListener('click', ()=>{ newLineRow(); recalc(); });
el('#vatToggle').addEventListener('change', recalc);
el('#discToggle').addEventListener('change', (e)=>{
  el('#discBox').style.display = e.target.checked ? 'grid' : 'none';
  recalc();
});
['#discBefore','#discAfter','#deposit','#client','#address','#phone'].forEach(s=>{
  el(s).addEventListener('input', recalc);
});
el('#btnSavePhone').addEventListener('click', saveToPhone);
el('#btnWaTop').addEventListener('click', shareWhatsApp);
el('#btnWaBottom').addEventListener('click', shareWhatsApp);
el('#btnPdf').addEventListener('click', ()=> window.print());

/* ---------- prevent “page wiggle” on iOS ---------- */
document.addEventListener('touchmove', (e)=>{
  if(!e.target.closest('input,select,textarea,canvas')) e.preventDefault();
},{passive:false});

/* ---------- boot ---------- */
generateContractNo();
newLineRow(); // first line
recalc();
loadFromPhone();
</script>
</body>
</html>
