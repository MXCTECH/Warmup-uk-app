<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Warm Up UK Homes – Contract</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; padding:12px; }
  h2 { display:flex; align-items:center; gap:10px; }
  .logo-top { height:48px; }
  .box { background:#fff; border:1px solid #ccc; padding:10px; margin-bottom:10px; border-radius:6px; }
  input,select,textarea { width:100%; padding:5px; margin-bottom:6px; box-sizing:border-box; border-radius:4px; border:1px solid #ccc; }
  table { width:100%; border-collapse:collapse; border-radius:6px; overflow:hidden; }
  th,td { border:1px solid #ddd; padding:5px; font-size:13px; }
  th { background:#f0f0f0; }
  button { padding:6px 10px; margin-top:5px; cursor:pointer; border:none; border-radius:4px; background:#000; color:#fff; }
  button:hover { opacity:0.85; }
  #sigCanvas,#waiverSigCanvas { background:#fff; border:1px solid #aaa; width:100%; touch-action:none; border-radius:4px; }
  .row { display:flex; gap:6px; }
  .row>div { flex:1; }
</style>
</head>

<body>
<h2>
  <img class="logo-top" src="https://via.placeholder.com/180x50?text=Warm+Up+UK+Homes" alt="Warm Up UK Homes">
  Warm Up UK Homes – Contract
</h2>

<!-- CLIENT DETAILS -->
<div class="box">
  <div class="row">
    <div><label>Client name</label><input id="clientName"></div>
    <div><label>Client phone (WhatsApp)</label><input id="clientPhone" placeholder="07..."></div>
  </div>
  <div class="row">
    <div><label>Address</label><input id="clientAddress"></div>
    <div><label>Postcode</label><input id="clientPostcode"></div>
  </div>
  <div class="row">
    <div><label>Booking agent</label><input id="bookingAgent"></div>
    <div><label>Confirmer</label><input id="confirmer"></div>
  </div>
  <div class="row">
    <div><label>Install date</label><input id="installDate" type="date"></div>
    <div><label><input id="startWithin14" type="checkbox"> Start within 14 days</label></div>
  </div>
</div>

<!-- PRODUCTS -->
<div class="box">
  <h3>Products / Works</h3>
  <table>
    <thead>
      <tr>
        <th>Product</th><th>Qty</th><th>£/Unit</th><th>Unit</th><th>Line £</th><th></th>
      </tr>
    </thead>
    <tbody id="itemsBody"></tbody>
  </table>
  <button onclick="addRow()">+ Add product</button>

  <div style="margin-top:10px">
    <div class="row"><div>Subtotal:</div><div><input id="subtotal" readonly></div></div>
    <div class="row"><div>Discount:</div>
      <div class="row" style="gap:3px;">
        <input id="discountVal" value="0" oninput="recalc()">
        <select id="discountType" onchange="recalc()"><option value="amount">£</option><option value="percent">%</option></select>
      </div>
    </div>
    <div class="row"><div><label><input id="vatOn" type="checkbox" checked onchange="recalc()"> VAT 20%</label></div><div><input id="vatAmt" readonly></div></div>
    <div class="row"><div>Deposit:</div><div><input id="deposit" value="0" oninput="recalc()"></div></div>
    <div class="row"><div><b>FINAL TOTAL:</b></div><div><input id="finalTotal" readonly style="font-weight:bold;"></div></div>
  </div>
</div>

<!-- NOTES -->
<div class="box"><h3>Notes</h3><textarea id="notes" rows="4"></textarea></div>

<!-- SIGNATURES -->
<div class="box">
  <h3>Main Signature (Client)</h3>
  <canvas id="sigCanvas" width="300" height="140"></canvas>
  <button onclick="clearSig()">Clear</button>
  <input id="signedBy" placeholder="Signed name">
</div>

<div class="box">
  <h3>14-Day Cancellation Waiver</h3>
  <p style="font-size:12px">
    By signing below, the client requests that Warm Up UK Homes commence works within the 14-day cooling-off period and acknowledges that their right to cancel may be reduced or lost once works begin.
  </p>
  <canvas id="waiverSigCanvas" width="300" height="120"></canvas>
  <button onclick="clearWaiverSig()">Clear waiver signature</button>
  <input id="waiverSignedBy" placeholder="Waiver signed name">
</div>

<!-- PDF / WHATSAPP -->
<div class="box">
  <h3>PDF & WhatsApp</h3>
  <button onclick="generatePDF()">Generate PDF</button>
  <input id="pdfLinkBox" readonly placeholder="PDF link appears here">
  <button onclick="sendWA()">Send to WhatsApp (with PDF link)</button>
  <input id="waLinkBox" readonly>
  <p id="waError" style="color:red;display:none">Add a phone number.</p>
</div>

<script>
/* ---------- PRODUCT ROWS ---------- */
function addRow(){
  const tb=document.getElementById("itemsBody");
  const tr=document.createElement("tr");

  const td1=document.createElement("td");
  const sel=document.createElement("select");
  ["Spray foam removal","Space wrap","Fibreglass","Loft hatch","Loft ladder","Loft boarding","Cavity wall"].forEach(p=>{
    const o=document.createElement("option");o.value=p;o.textContent=p;sel.appendChild(o);
  });
  td1.appendChild(sel);tr.appendChild(td1);

  const td2=document.createElement("td");const q=document.createElement("input");
  q.type="number";q.value=0;q.oninput=recalc;td2.appendChild(q);tr.appendChild(td2);

  const td3=document.createElement("td");const pr=document.createElement("input");
  pr.type="number";pr.value=0;pr.oninput=recalc;td3.appendChild(pr);tr.appendChild(td3);

  const td4=document.createElement("td");
  const u=document.createElement("select");
  ["job","item","m²","lm"].forEach(v=>{const o=document.createElement("option");o.value=v;o.textContent=v;u.appendChild(o);});
  td4.appendChild(u);tr.appendChild(td4);

  const td5=document.createElement("td");const lt=document.createElement("input");
  lt.readOnly=true;lt.value="0.00";td5.appendChild(lt);tr.appendChild(td5);

  const td6=document.createElement("td");
  const del=document.createElement("button");del.textContent="X";
  del.style.background="#a00";del.onclick=()=>{tr.remove();recalc();};
  td6.appendChild(del);tr.appendChild(td6);

  tb.appendChild(tr);
  recalc();
}
addRow();

/* ---------- TOTALS ---------- */
function recalc(){
  const rows=document.getElementById("itemsBody").rows;let subtotal=0;
  for(const r of rows){
    const qty=parseFloat(r.cells[1].children[0].value)||0;
    const price=parseFloat(r.cells[2].children[0].value)||0;
    const line=qty*price;r.cells[4].children[0].value=line.toFixed(2);subtotal+=line;
  }
  document.getElementById("subtotal").value="£"+subtotal.toFixed(2);
  let disc=parseFloat(document.getElementById("discountVal").value)||0;
  const type=document.getElementById("discountType").value;let after=subtotal;
  if(disc>0){if(type==="percent"){disc=subtotal*(disc/100);}after=Math.max(0,subtotal-disc);}
  let vat=document.getElementById("vatOn").checked?after*0.2:0;
  document.getElementById("vatAmt").value="£"+vat.toFixed(2);
  const dep=parseFloat(document.getElementById("deposit").value)||0;
  const final=Math.max(0,after+vat-dep);
  document.getElementById("finalTotal").value="£"+final.toFixed(2);
  return{subtotal,discount:disc,afterDisc:after,vat,deposit:dep,final};
}

/* ---------- SIGNATURE CANVASES ---------- */
function makeCanvasDrawable(cvs){
  const ctx=cvs.getContext("2d");ctx.lineWidth=2;ctx.lineCap="round";let drawing=false;
  function pos(e){const r=cvs.getBoundingClientRect();return e.touches?{x:e.touches[0].clientX-r.left,y:e.touches[0].clientY-r.top}:{x:e.clientX-r.left,y:e.clientY-r.top};}
  cvs.addEventListener("mousedown",e=>{drawing=true;const p=pos(e);ctx.beginPath();ctx.moveTo(p.x,p.y);});
  cvs.addEventListener("mousemove",e=>{if(!drawing)return;const p=pos(e);ctx.lineTo(p.x,p.y);ctx.stroke();});
  ["mouseup","mouseleave"].forEach(v=>cvs.addEventListener(v,()=>drawing=false));
  cvs.addEventListener("touchstart",e=>{e.preventDefault();drawing=true;const p=pos(e);ctx.beginPath();ctx.moveTo(p.x,p.y);},{passive:false});
  cvs.addEventListener("touchmove",e=>{e.preventDefault();if(!drawing)return;const p=pos(e);ctx.lineTo(p.x,p.y);ctx.stroke();},{passive:false});
  cvs.addEventListener("touchend",()=>drawing=false,{passive:false});
  return ctx;
}
const sigCtx=makeCanvasDrawable(document.getElementById("sigCanvas"));
const waiverCtx=makeCanvasDrawable(document.getElementById("waiverSigCanvas"));
function clearSig(){sigCtx.clearRect(0,0,300,140);}
function clearWaiverSig(){waiverCtx.clearRect(0,0,300,120);}

/* ---------- PDF GENERATION ---------- */
async function generatePDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p","mm","a4");
  const totals=recalc();
  const name=document.getElementById("clientName").value||"-";
  const addr=(document.getElementById("clientAddress").value||"-")+" "+(document.getElementById("clientPostcode").value||"");
  const phone=document.getElementById("clientPhone").value||"-";
  const notes=document.getElementById("notes").value||"-";
  const signedBy=document.getElementById("signedBy").value||"Pending";
  const waiverSignedBy=document.getElementById("waiverSignedBy").value||"";
  const start=document.getElementById("startWithin14").checked;
  const today=new Date().toISOString().slice(0,10);
  const contract="WUU-"+today.replace(/-/g,"")+"-"+Math.floor(Math.random()*999);

  /* Header */
  doc.setFillColor(0,0,0);doc.rect(0,0,210,25,"F");
  doc.setTextColor(255,255,255);
  doc.setFontSize(14);doc.text("Warm Up UK Homes",10,15);
  doc.setFontSize(9);doc.text("Contract "+contract,150,15);
  doc.setTextColor(0,0,0);

  /* Client */
  doc.setFontSize(9);
  doc.text(`Client: ${name}`,10,33);
  doc.text(`Address: ${addr}`,10,38);
  doc.text(`Phone: ${phone}`,10,43);

  /* Products table */
  let y=50;
  doc.setFillColor(245,245,245);doc.rect(10,y,190,8,"F");
  doc.setDrawColor(200,200,200);
  doc.rect(10,y,190,8);
  doc.text("Description",12,y+5);doc.text("Qty",120,y+5);
  doc.text("£/Unit",135,y+5);doc.text("Unit",155,y+5);doc.text("Line £",175,y+5);
  y+=9;
  const rows=document.getElementById("itemsBody").rows;
  for(const r of rows){
    const item=r.cells[0].children[0].value;
    const qty=r.cells[1].children[0].value;
    const price=r.cells[2].children[0].value;
    const unit=r.cells[3].children[0].value;
    const line=r.cells[4].children[0].value;
    doc.rect(10,y,190,7);
    doc.text(item,12,y+4);
    doc.text(String(qty),120,y+4);
    doc.text("£"+Number(price||0).toFixed(2),135,y+4);
    doc.text(unit,155,y+4);
    doc.text("£"+(line||"0.00"),175,y+4);
    y+=7;
  }

  /* Totals box */
  doc.setDrawColor(200,200,200);
  doc.setFillColor(250,250,250);
  doc.rect(120,y+4,80,35,"F");
  doc.setFontSize(9);
  doc.text("Subtotal: £"+totals.subtotal.toFixed(2),122,y+10);
  doc.text("Discount: £"+totals.discount.toFixed(2),122,y+15);
  doc.text("VAT 20%: £"+totals.vat.toFixed(2),122,y+20);
  doc.text("Deposit: £"+totals.deposit.toFixed(2),122,y+25);
  doc.setTextColor(212,175,55);
  doc.setFontSize(11);
  doc.text("TOTAL £"+totals.final.toFixed(2),122,y+33);
  doc.setTextColor(0,0,0);

  /* Signature */
  const sig=document.getElementById("sigCanvas").toDataURL("image/png");
  doc.setFontSize(9);
  doc.text("Client Signature:",10,y+55);
  doc.addImage(sig,"PNG",35,y+45,70,28);
  doc.text("Signed by: "+signedBy,10,y+80);

  /* Waiver box */
  if(start){
    doc.setDrawColor(200,0,0);
    doc.setFillColor(255,240,240);
    doc.rect(10,y+90,190,35,"F");
    doc.setTextColor(200,0,0);
    doc.text("14-Day Cancellation Waiver",12,y+96);
    doc.setTextColor(0,0,0);
    const waiver=document.getElementById("waiverSigCanvas").toDataURL("image/png");
    doc.addImage(waiver,"PNG",130,y+93,60,25);
    doc.setFontSize(7);
    const wt="I/we request that Warm Up UK Homes commence the agreed works within the statutory 14-day period and understand that cancellation rights may be reduced or lost once works/materials begin.";
    const wtLines=doc.splitTextToSize(wt,110);
    doc.text(wtLines,12,y+103);
    doc.text("Waiver signed by: "+(waiverSignedBy||"Pending"),12,y+121);
  }

  /* Terms */
  doc.addPage();
  doc.setFontSize(10);
  doc.text("Terms & Conditions – Warm Up UK Homes",10,12);
  doc.setDrawColor(220,220,220);
  doc.rect(8,15,194,267);
  doc.setFontSize(7);
  const tcs=[
    "1. Cooling-off period 14 days unless waived by client; charges may apply for early start.",
    "2. Access must be safe and clear of obstructions for installers.",
    "3. Scope limited to items listed on this contract.",
    "4. Payment due on completion unless otherwise agreed.",
    "5. Materials and warranties as per manufacturer terms.",
    "6. Not liable for pre-existing defects (damp, condensation, electrics, structure).",
    "7. Compliance requires full access and information from client.",
    "8. Missed visits may incur a re-attendance fee.",
    "9. Goods remain property of Warm Up UK Homes until paid in full.",
    "
